Abstract
A family of Markov blankets, if learned purely as a set of subsets of variables, may not be consistent with any Bayesian network. This inconsistency may have a negative impact on Markov blanket-based structure learning. In this paper, we propose checking Markov blanket consistency using graph morality. We define an alternative concept of moral graph – weak recursive simpliciality – without relying on Bayesian networks. Although it is NP-complete to decide if an undirected graph in general is moral, we propose linear and quadratic time algorithms for deciding morality for maximum degree 3 and 4 graphs respectively. In addition, we prove that the problem remains NP-complete for graphs with maximum degree higher than 4, hence there are no remaining unknown complexities for this kind of problem.


Keywords
Markov blanket
Moral graph
Weakly recursive simplicial
Computational complexity

1. Introduction
Introduced by [7] as the smallest subset of variables in a Bayesian network (BN), given which the target variable is conditionally independent from the rest of the variables, the Markov blanket1 has become popular for feature selection [4] and scaling up learning causal models [1], [2], [10]. Throughout, we assume each BN is faithful, that is, its joint probability distribution and the directed acyclic graph (DAG) entail exactly the same conditional independences. In a BN, the Markov blanket (MB) of a target variable consists of its parents, children and children's other parents (a.k.a., spouses). For example, the MB of vertex 
 in Fig. 1.1a is 
. A set 
 of subsets of variables is a valid family of MBs for the variables 
 in a BN if it satisfies the symmetry and consistency properties. The symmetry property, which states 
 if and only if 
 is a consequence of the graphical interpretation of MBs. The consistency property states that there must exist at least one DAG that admits  as its MBs.

Fig. 1.1
Download : Download high-res image (17KB)
Download : Download full-size image
Fig. 1.1. An example of a DAG and its moral graph.

A family of learned MBs, if not read off from a DAG, does not report the explicit causal relations among variables. This does not prevent symmetry being quickly checked and enforced. Previous work in [12], [9], [6], [1], [2] enforced symmetry arbitrarily by taking either the union or the intersection of MBs. It is, however, non-trivial to check the consistency property. Without being consistent with some DAG, one is certain that the MBs are incorrect under the assumption that the generating model is a faithful BN with no hidden variables. Until now, there has been no literature paying attention to MB consistency. Therefore, one of the motivations is to address the importance of this property and its potential effect on structure learning and feature selection algorithms that use the MB approach.

The second motivation of this paper is to emphasize the equivalence of MB consistency and graph morality. The concept of a moral graph was introduced in [5] as part of the junction-tree algorithm for belief propagation on BNs. The moral graph of a BN can be trivially obtained by connecting non-adjacent parents for each vertex in the BN and dropping the direction of each edge. The graph in Fig. 1.1b is the moral graph of the DAG in Fig. 1.1a. A vertex and each one of its non-adjacent spouses in the DAG will be connected during the moralization process. This implies that the MB of each vertex in a DAG becomes the vertex's neighbourhood in the moral graph. Hence, the MBs are consistent with a DAG if and only if the neighbourhoods are consistent with a DAG, which is the case if and only if the undirected graph (formed by the neighbourhoods) is consistent with a DAG, which is the same as saying the undirected graph is moral.

Despite the simplicity of obtaining the moral graph from a BN, it was proved [13] that deciding graph morality is NP-complete. Here, we present efficient algorithms to check morality for undirected graphs with maximum degree of 4 or less. The algorithms can also be used to immoralize a candidate graph to a DAG pattern (i.e., a partially directed graph that represents a statistical equivalence class of DAGs) by assigning directions to edges incident on a simplicial vertex, i.e., one whose neighbours form a complete subgraph. This provides an efficient way to check if a maximum degree 4 undirected graphical model (e.g., a Markov model) admits a causal interpretation [see 8]. Furthermore, this paper closes the time complexity gap of the graph morality problem in the dimension of maximum degree by proving the NP-completeness of deciding morality for graphs with maximum degree of 5 based on a modification of the proof presented in [13].

Section 2 gives some important definitions. In Section 3, we prove that being moral is equivalent to being weakly recursively simplicial. In Section 4, we present linear and quadratic time algorithms for maximum degree 3 and 4 graphs respectively. In addition, we prove the hardness of deciding morality for undirected graphs with maximum degree of 5.

2. Preliminaries
Throughout, we consider only simple graphs. If a graph is not connected, we will treat one (connected) component at a time. For simplicity, we refer to them as graphs. Let  be a graph and 
 be a subset of vertices. We use 
 to denote the induced subgraph 
. If the set 
 for a subgraph , then we use  to emphasize the deletion of the vertices of H. This can be further simplified to  if 
 is a single vertex. Similarly, let 
 be a subset of edges, we use 
 to denote the subgraph over V with edges 
. If 
 then we use 
 to denote the supergraph graph over V with edges 
. The notation is simplified to  or  if the set 
 is a single edge.

Let G be a graph. A simplicial vertex in G is a vertex whose neighbours form a complete subgraph. The deficiency of a vertex u in G is the set of edges 
, whose addition makes the neighbourhood of u complete. Clearly, vertex u of G is simplicial if and only if 
. A graph G is weakly recursively simplicial (WRS) if it has a simplicial vertex u and a subset of edges 
 between the neighbours of u such that the subgraph 
 is weakly recursively simplicial. By convention, the empty graph is WRS. The subset 
 may be an empty set, which implies that chordal graphs are WRS. The subgraph obtained from G by eliminating a simplicial vertex and some edges between its neighbours is called an elimination graph. Starting from the original graph G, a sequence of eliminations can lead to an empty graph if G is WRS. It is, however, impossible to completely eliminate G if the graph G is not WRS. For example, the graph in Fig. 2.1a is WRS and can be completely eliminated by removing 
. The graph in Fig. 2.1b, however, is not WRS.

Fig. 2.1
Download : Download high-res image (18KB)
Download : Download full-size image
Fig. 2.1. Examples of a WRS and non-WRS graphs.

Let  be a Bayesian network. The Markov blanket of a variable  in the BN, denoted by , is the minimum subset of variables satisfying the conditional independency

Image 1
for each variable , where . We use 
 to denote a directed edge from a vertex u to v and  to denote u is a parent of v. The moral graph of a directed acyclic graph  is the underlying undirected structure of the graph , where the set of additional edges 
 connects non-adjacent parents of each vertex x in G. This definition implicitly states a trivial moralization process that turns a DAG into its moral graph.
3. Morality and weak recursive simpliciality
We now prove the equivalence of moral graphs and WRS graphs. This is done by the following two lemmas.

Lemma 3.1

Let G be a DAG and H be the moral graph of G. Then H is WRS.

Lemma 3.2

Let H be a WRS graph. Then H is the moral graph of a DAG.

Both lemmas are proved by induction on the number of vertices. The key idea is that every DAG has a sink that becomes a simplicial vertex after moralization. The detailed proofs are contained in Appendix A.

Theorem 3.1

A graph is moral if and only if it is WRS.

Proof

The theorem follows from Lemma 3.1, Lemma 3.2. □

The theorem gives a different way of checking morality when it is not known if a graph results from moralizing a DAG. Note that chordal implies moral, because a chordal graph, also known as recursively simplicial, is a special case of WRS where no edge is removed when deleting a simplicial vertex. The converse is not necessarily true (e.g., Fig. 1.1b). In general, a graph can have more than one simplicial vertex. Next, we prove that the recursive WRS process can start eliminating any simplicial vertex.

Lemma 3.3

Let H be a WRS graph. For any simplicial vertex u, the graph H can be eliminated completely by starting with u.

Proof

Theorem 3.1 implies that there is a DAG G, whose moral graph is H. For any sink u in G, the subgraph 
 is also a DAG. Let 
 be the moral graph of 
. It implies that 
 for a subset 
 of edges between the neighbours of u. By Theorem 3.1, the graph 
 can be completely eliminated. Hence, adding u and S to the front of the elimination process will eliminate H completely. □

Based on Theorem 3.1 and Lemma 3.3, it is possible to use a backtracking algorithm to decide whether or not a given graph G is moral. If it is, the algorithm will return TRUE and orient G into a hybrid graph, of which there always exist a consistent DAG extension as proved by Dor and Tarsi [3].

The following two remarks are also made in [13]. Being necessary conditions for a graph to be moral, they can be used to reduce the running time of the backtracking Algorithm.

Remark 3.1

If a graph is moral, it has at least one simplicial vertex.

Remark 3.2

If a graph is moral, each cycle of length at least 4 in it shares an edge with a k-clique for .

4. Complexity of checking morality
The WRS property gives us a way to check morality. However, it was proved [13] that deciding morality is NP-complete. This is not so surprising because, first, the number of subsets of edges between a simplicial vertex's neighbours can grow exponentially with the degree of the vertex, and, second, the deletion of some edges can stop a vertex being simplicial in a later recursive step, which cannot be anticipated at the time of that deletion. Noting that high vertex degree can be a cause of exponential time complexity, we next consider restricted maximum degrees starting with the easy case of 3.

4.1. Maximum degree three graphs
It is trivial to check morality for graphs with the maximum degree at most 2, because all graphs in this case are chordal and can be recognized in polynomial time [11]. To prove that there exists a polynomial time algorithm for maximum degree 3 graphs, we prove the following lemmas first. We use 
 to denote the set of edges between the neighbours of the vertex x. The next lemma states that if a graph is not moral, adding an edge between non-adjacent vertices who have no common neighbours will not make it moral.

Lemma 4.1

Let  be a non-moral graph. If two vertices  have no common neighbours in G, then the supergraph  is not moral.

Proof

The graph G is not moral implies two possibilities. First, G has no simplicial vertex at all. Second, G has some simplicial vertices but G cannot be fully eliminated to the empty graph. The two cases are dealt separately.

Case 1: . The only chance to turn a non-simplicial vertex x in the graph G into a simplicial vertex in the supergraph H is to add x's deficiency to G so that its deficiency 
. This requires x to be the common neighbour of the two end vertices  of each added edge. Hence, the premise  have no common neighbour in G implies that the supergraph H remains non-moral.

Case 2: . The assumption G is non-moral but has simplicial vertices implies that for all elimination process, there always exists a proper subgraph  that is non-empty. If the supergraph H is moral, then the additional edge uv must enable a simplicial vertex x by emptying its deficiency in the corresponding elimination graph. This is true only in the cases where the deficiency of x in the subgraph F is 
 or 
 as shown in Fig. 4.1. Both cases, however, contradict with the assumption that  have no common neighbours in G. Therefore, the supergraph H remains non-moral. □

Fig. 4.1
Download : Download high-res image (18KB)
Download : Download full-size image
Fig. 4.1. Adding the edge uv makes the vertex x simplicial in a corresponding elimination graph.

The benefit of having low vertex degree is that each vertex can be connected to the rest of the graph in only a few ways. Based on this, we show in the next lemma that under a certain case, morality is preserved after removing a simplicial vertex and all the edges between its neighbours. Define the closed neighbourhood of a vertex x to be  the union of x's neighbourhood and itself.

Lemma 4.2

Let G be a moral graph that contains a simplicial vertex x. If each pair of x's neighbours have common neighbours only in the closed neighbourhood 
 of x, then the subgraph 
 is moral.

Proof

Assume the subgraph 
 is not moral. The deletion of the edges in 
 implies that every pair of x's neighbours  are non-adjacent in 
. In addition, the fact that 's common neighbours form a subset of 
 implies 
. By Lemma 4.1, no non-empty proper subset 
 of edges between the neighbours of x can make the subgraph 
 moral. Moreover, since u and v have no common neighbours in 
, the graph 
 has no additional simplicial vertices than 
, hence is not moral either. Hence, for any subset 
 of edges between the neighbours of x, the subgraph  is non-moral. By Lemma 3.3, the morality of G can be checked by starting with any simplicial vertex. Therefore,  is not moral contradicts G being moral, so 
 must be moral. □

Based on Lemma 4.2, we conclude that the morality of maximum degree 3 graphs can be checked by recursively removing a simplicial vertex and all the edges between its neighbours. This is proved in the next lemma.

Lemma 4.3

Let G be a moral graph with maximum degree 3. If G has a simplicial vertex x, then the subgraph 
 is moral.

Proof

When the vertex x has degree 
, it is a leaf in G and can be removed without causing any issue in the following steps. When 
, the closed neighbourhood 
 of x forms a clique and each vertex in 
 has degree 3. The assumption that G is connected then implies that G is a complete graph over 4 vertices. When x has degree 
, the neighbourhood 
 contains two vertices. If  have no common neighbours besides the vertex x as shown in Fig. 4.2a, then 
 is moral by Lemma 4.2. If  have another other common neighbour y in G as shown in Fig. 4.2b, then they reach the maximum. Hence, the rest of the graph is connected to the induced subgraph over  via the vertex y only. Therefore, the subgraph 
 is moral too. □

Fig. 4.2
Download : Download high-res image (22KB)
Download : Download full-size image
Fig. 4.2. Two maximum degree 3 graphs. The vertex x is simplicial with two neighbours u,v.

Algorithm 1 in Appendix B presents pseudocode for checking morality of graphs with maximum degree 3. At each step of the While loop the algorithm eliminates from the input graph a simplicial vertex and all the edges between its neighbours. Once finished, the algorithm returns TRUE if the graph is fully eliminated, otherwise it returns FALSE. A theorem completes this section:

Algorithm 1
Download : Download high-res image (40KB)
Download : Download full-size image
Algorithm 1. Checking morality for maximum degree 3 graphs.

Theorem 4.1

The morality of maximum degree 3 graphs can be decided in linear time.

Proof

The correctness of Algorithm 1 is proved by Lemma 4.3. Assume a graph with n vertices is represented by an adjacency list. Since each vertex's degree is bounded above by 3, it takes  time to check the simplicity of a vertex x. Initially, the algorithm spends  time to check simpliciality for all n vertices and store the simplicial vertices in a queue. Due to the bounded maximum degree, not only the vertex and edge removals take constant time, but the deletions affect the simpliciality at most a constant number of neighbours. So the queue can be updated in constant time. Therefore, Algorithm 1 runs in  time. □

4.2. Maximum degree four graphs
Higher maximum degree allows a simplicial vertex more freedom when connecting to the rest of the graph, therefore different choices of edge removal need to be considered when removing a simplicial vertex, depending on its degree in the corresponding elimination graph. Later in the section, we prove that in some cases, simplicial vertices must be removed in a fixed order in terms of their degrees. Again, we use 
 to denote the set 
 of all edges between the vertex u's neighbours in a graph G. First, we get rid of simplicial vertices with degrees  and 4. The proof is similar to Lemma 4.3, so it is included in Appendix A.

Lemma 4.4

Let G be a moral graph with maximum degree 4. If a vertex x is simplicial in G and its degree 
, then the subgraph 
 is moral.

Before looking into the case where a simplicial vertex is of degree 2, we define another concept that is useful for separating the case into subcases. Let 
, 
 and 
 be three non-intersect paths of length n,  and n respectively for . A 3-clique path is a graph that is obtained by either

•
adding the edges 
 and 
 between P and 
 for each , or by

•
adding the edges 
, 
 and 
 between P and 
 for each .

By definition, the number of vertices must satisfy  for otherwise the path 
 is an empty graph. The length of a 3-clique path is equal to the number of distinct 3-cliques it contains. When connecting vertices between the paths P and 
, the 3-clique path contains an odd number of 3-cliques and hence its length is equal to . When connecting vertices between the paths P and 
, the 3-clique path contains an even number of 3-cliques and hence its length is equal to . We use 
 to denote a 3-clique path of length m. That is, a 3-clique path that contains m distinct 3-cliques. Since this section focuses on maximum degree 4 graphs, the only vertices that do not reach the maximum degree are the two vertices (with degree 2 and 3 respectively) at each end of a 3-clique path. For example, Fig. 4.3a is a 3-clique path of length 2, where the two paths are 
 and 
. The vertices 
 and 
 are at the left end of the 3-clique path 
 and their degrees are 2 and 3 respectively. The vertices 
 and 
 are at the right end of 
 and their degrees are also 2 and 3 respectively. The graph in Fig. 4.3b contains three 3-clique paths of length 3, over the sets of vertices 
, 
 and 
 respectively. In the induced subgraph 
 over 
, only the vertex 
 reaches the maximum degree 4.

Fig. 4.3
Download : Download high-res image (25KB)
Download : Download full-size image
Fig. 4.3. Examples of a length 2 3-clique path over {v1,v2,v3,v4} and three length 3 3-clique paths over {v1,v2,v3,v4,v5}, {v1,v2,v4,v5,v6} and {v2,v3,v4,v5,v6}.

A 3-clique path in a graph G is maximal if it is not a proper subgraph of another 3-clique path in G. For example, the 3-clique path over 
 in the graph shown in Fig. 4.3b is not maximal, because it is contained as a proper subgraph of the 3-clique path over 
. The 3-clique path over 
, however, is maximal because it is not a proper subgraph of any other 3-clique path. Since in most situations we only deal with maximal cases, all the 3-clique paths considered in this section are assumed to be maximal unless stated otherwise.

Corollary 4.1

Let G be a moral graph with the maximum degree 4. Assume G contains a 3-clique path 
 of length 1 as a subgraph. If a degree 2 vertex 
 is simplicial, then the subgraph 
 is moral.

Proof

This follows from Lemma 4.2, because the two neighbours of 
 have no common neighbour other than 
. □

The next lemma demonstrates how morality can be preserved when deleting a degree 2 simplicial vertex that is in a 3-clique path of length 2.

Lemma 4.5

Let G be a moral graph with maximum degree 4. Assume G contains a 3-clique path 
 of length 2. If a degree 2 vertex 
 is simplicial, then the subgraph 
 is moral.

Proof

The graph G is shown in Fig. 4.4. Assume the subgraph 
 is not moral. This implies that no sequence of eliminations from 
 can lead to an empty graph. Let 
 be another subgraph of G that is different from 
 by the edge 
. By Lemma 3.3, the morality of G and the immorality of its subgraph 
 imply that 
 must be moral. The assumption that the 3-clique path over 
 is maximal implies that neither 
 nor 
 has a common neighbour with 
. The fact that 
 and 
 are not connected in 
 implies that no sequence of eliminations that completely eliminates 
 can delete 
 before 
 and 
. Assuming without loss of generality that a sequence of eliminations that completely eliminates the subgraph 
 removes the vertex 
 prior to 
. Then the same sequence also eliminate the subgraph 
 completely because the two subgraphs are different by only one edge 
 and this edge is removed from 
 when vertex 
 is removed. Hence, the subgraph 
 is also moral, which contradicts with the assumption that it is not. Therefore, 
 is a moral graph. □

Fig. 4.4
Download : Download high-res image (9KB)
Download : Download full-size image
Fig. 4.4. A maximum degree 4 graph that contains a 3-clique path of length 2.

The following three lemmas consider the case when a degree 2 simplicial vertex is in a 3-clique path of length 3. The middle 3-clique may be critical to the following elimination steps, depending on how the vertices 
 are connected to the rest of the graph. Without loss of generality, assume a 3-clique path 
 is over the set of vertices 
 with vertex degrees 
, 
 and 
.

Lemma 4.6

Let G be a moral graph with maximum degree 4. Assume G contains a 3-clique path 
 of length 3 as a subgraph. If a degree 2 vertex 
 is simplicial and the distance 
 between the two degree 3 vertices in the subgraph 
, then the subgraph 
 is moral.

Proof

The graph G is shown in Fig. 4.5a or 4.5b. Assume the subgraph 
 is not moral. Let 
 be another subgraph of G that is obtained by adding to 
 the edge 
. This edge addition guarantees a 3-clique over 
 in 
. But this clique is only useful for the WRS process if it can break unbreakable cycles in 
. The degree 
 implies that the edges 
 and 
 do not appear in any cycles other than those in 
. Furthermore, the distance 
 in the subgraph 
 is either 2 or infinity implies that the edge 
 is not in any cycle of length at least 4. Hence, if the subgraph 
 is not moral the subgraph 
 is not moral either. This contradicts the premise that G is moral. Therefore, the subgraph 
 must be moral. □

Fig. 4.5
Download : Download high-res image (30KB)
Download : Download full-size image
Fig. 4.5. Two maximum degree 4 graphs G. Each contains a 3-clique path of length 3 as a subgraph. The subgraph H = G − {v1,v2,v3}−v4v5.

Lemma 4.7

Let G be a moral graph with the maximum degree 4. Assume G contains a 3-clique path 
 of length 3 as a subgraph. If both degree 2 vertices 
 and 
 are simplicial and the distance 
 between the two degree 3 vertices in the subgraph 
, then the subgraph 
 is moral.

Proof

The graph G is shown in Fig. 4.6a. Since the vertices 
 and 
 reach the maximum degree 4, the two 3-cliques over 
 and 
 do not share edges with any cycle in G that does not contain the 3-clique 
. Assume without loss of generality that the there is a four cycle over 
. Removing the two simplicial vertices 
 renders the vertex 
 simplicial in the elimination graph, which can break the four cycle. Therefore, if G is moral then the subgraph 
 remains moral. □

Fig. 4.6
Download : Download high-res image (31KB)
Download : Download full-size image
Fig. 4.6. Two maximum degree 4 graphs. Each contains a 
 as a subgraph. The distance d(v4,v5)∈[3,∞) in the subgraph G − {v1,v2,v3}−v4v5.

Lemma 4.8

Let G be a moral graph with the maximum degree 4. Assume G contains a 3-clique path 
 of length 3 as a subgraph. If the vertex 
 is simplicial while the vertex 
 is not and the distance 
 between the two degree 3 vertices in the subgraph 
, then the subgraph 
 is moral.

Proof

Assume without loss of generality that there is only one simplicial vertex in the graph G as shown in Fig. 4.6b. Removing the simplicial vertex 
 does not introduce new simplicial vertices in the elimination graph. Hence, if G is moral, the subgraph 
 must be moral too. □

So far, we have considered the case when a degree 2 simplicial vertex is in a 3-clique path of length at most 3. The next lemma shows how a long path of length at least 4 can be shortened while morality is still preserved.

Lemma 4.9

Let G be a moral graph with the maximum degree 4. Assume G contains a 3-clique path 
 of length . If a degree 2 vertex 
 is simplicial, then the subgraph 
 is moral.

Proof

Assume the graph G contains a 3-clique path of length 4 as shown in Fig. 4.7. Since the vertex 
 reaches the maximum degree 4 and 
 is simplicial, the subgraph 
 remains moral after removing 
 from G. In addition, the length of the 3-clique path reduced by 2. □

Fig. 4.7
Download : Download high-res image (9KB)
Download : Download full-size image
Fig. 4.7. An example of a 3-clique path of length 5.

It can be seen from this lemma that after deleting a simplicial vertex, the number of 3-cliques that a path contains is reduced by 2 and consequently the length of the 3-clique path is decreased by 2. Therefore, we always deal with a simplicial vertex that is in a long 3-clique path first. The aim is to reduce the length of a long path to either  or 3, so that it can then be dealt with by using the actions proved previously. Algorithm 2 in Appendix B is the pseudocode for checking morality for graphs with maximum degree 4. The algorithm deals with simplicial vertices that are in different conditions in a fixed order. Fig. 4.8 shows two examples of moral graphs that cannot be completely eliminated if simplicial vertices are removed in a different order.

Algorithm 2
Download : Download high-res image (141KB)
Download : Download full-size image
Algorithm 2. Checking morality for maximum degree 4 graphs.

Fig. 4.8
Download : Download high-res image (44KB)
Download : Download full-size image
Fig. 4.8. Two maximum degree 4 moral graphs, whose simplicial vertices are in 
s. The simplicial vertices must be removed in the order stated in Algorithm 2, otherwise these graphs will not be recognized as moral by taking the actions proved in the above lemmas.

Theorem 4.2

The morality of maximum degree 4 graphs can be decided in quadratic time.

Proof

The correctness of Algorithm 2 can be proved by the corollary and lemmas proved in this section.

The algorithm takes an initial  time to get a queue of simplicial vertices in the current graph. Because of the limited maximum degree, it takes  time to find a simplicial vertex's degree, remove it and its neighbouring edges. The worst case of this algorithm appears in the case when a simplicial vertex has degree 2, because the algorithm needs to know the length of a 3-clique path. This process, however, can be done in  time because it is sufficient to identify the length of a path up to 4. Once a path of length 3 is discovered, it takes  time to run the breadth-first-search to calculate the distance 
 in the corresponding subgraph, where e is the number of edges in the graph. The maximum degree 4 constraint implies that the number of edges in the worst case increases linearly in the number of vertices, so the running time of the breadth-first-search is . Assuming the algorithm always produces a new degree 2 simplicial vertex that will be added into the queue. Therefore, the algorithm runs in 
 time in the worst case. □

It can be seen that Algorithm 2 also works for maximum degree 3 graphs. Because degree 1 and 3 simplicial vertices can be dealt with line 4 and 6 of Algorithm 2. As vertex degree is bounded by 3, a degree 2 simplicial vertex is in a 3-clique path of length at most 2. Line 11 takes the same action as Algorithm 1. Although line 13 removes only the simplicial vertex, it has the same effect as removing both 
 and 
 because both neighbours of 
 have the degree 3 and consequently are not incident to the rest of the graph.

To this point, we have proved that for graphs with maximum degree 3 and 4, their morality can be decided in polynomial time. This is equivalent to saying the consistency of a family of learned MBs (with maximum size is at most 4) can be checked in polynomial time. In the next section, we prove that the problem remains NP-complete for graphs with higher maximum degrees.

4.3. Graphs with larger maximum degrees
It has been proved by Verma and Pearl [13] that deciding morality is an NP-complete problem. The hardness for general graphs arises from the freedom of deleting different subset of edges between the neighbours of a simplicial vertex, which could lead to a dead end in the following steps that is impossible to anticipate at the time of deletion. This is not an issue for lower maximum degree graphs as has been demonstrated in the preceding sections. However, as it will be shown in the next theorem that the problem remains NP-complete for maximum degree 5 graphs. Thus, there are no remaining unknown complexities for this kind of problem.2

Theorem 4.3

The problem of deciding morality for maximum degree 5 graphs is NP-complete.

The theorem can be straightforwardly proved by modifying the reduction in [13] to build graphs with max degree 5 based on an input 3SAT formula ϕ. The following is a sketch of the proof. The formal proof of the theorem is included in Appendix C.

Denote each variable in ϕ by 
 and each clause by 
. The reduction starts by building a variable gadget for each variable 
 and a clause gadget for each clause 
 to simulate the behaviour of a variable and clause in the formula ϕ. It then builds two auxiliary gadgets to connect all the variable and clause gadgets together to form a desired graph. We need to prove that such a reduction always produces graphs with maximum degree 5 and the produced graph is moral if and only if the input formula is satisfiable. Most of the work in [13] is sufficient to prove Theorem 4.3, except that the auxiliary gadget and how the gadgets are connected to each other must be modified to avoid violating the maximum degree 5 constraint. As we have introduced the concept of WRS, we will assess a graph's morality by testing its weak recursive simpliciality rather than directing it to obtain a DAG (as Verma and Pearl [13] did).

The next corollary follows from the above theorem.

Corollary 4.2

The problem of deciding morality for graphs with maximum degree at least 5 is NP-complete.

5. Conclusion
In this paper, we emphasized the importance of MB consistency for structure learning and feature selection using the MB approach. We drew a connection between checking MB consistency and graph morality. Despite the NP-completeness of deciding morality, we proposed linear and quadratic time algorithms for deciding morality for graphs with maximum degree 3 and 4 respectively. The algorithms were developed based on a newly defined equivalent property of morality, namely weak recursive simpliciality. We also closed the gap between P and NP-complete for this problem when varying a graph's maximum degree by modifying the proof in [13] to always produce graphs with maximum degree 5.

The paper leaves an interesting open question. The NP-completeness of deciding morality implies that the minimum and minimal moralizations are NP-hard too. It would be useful to develop fast approximation algorithms that moralize undirected graphs without filling in too many edges.

Appendix A. Proofs of WRS
Lemma A.1 Lemma 3.1

Let G be a DAG and H be the moral graph of G. Then H is WRS.

Proof

The lemma is proved by induction on the number of vertices. Let  and  denote, respectively, a DAG and its moral graph over n vertices. The lemma is true for , because all graphs containing at most three vertices or less are chordal, so WRS. Assuming for  that the moral graph  of any n-vertex DAG is WRS. We want to show that the moral graph  of any DAG  is also WRS.

Each DAG contains a sink. For example, in Fig. A.1a the vertex 
 in the DAG  is a sink. This vertex becomes simplicial in  because its parents form a clique by moralization. By removing 
 from  we obtain a subgraph  that is also a DAG. In addition, 's moral graph  is a subgraph of the moral graph  because they are different by the vertex 
, the edges incident to 
 and the edge between 
's parents 
 in . The inductive hypothesis assumes that each moral graph  is WRS. Therefore, the supergraph  is also WRS. □

Fig. A.1
Download : Download high-res image (117KB)
Download : Download full-size image
Fig. A.1. Vertex addition and removal between DAGs and their corresponding moral graphs.

Lemma A.2 Lemma 3.2

Let H be a WRS graph. Then H is the moral graph of a DAG.

Proof

Let  denote a WRS graph over n vertices and  as defined above. The statement is true for , because a single node graph  is a WRS graph as well as the moral graph of the DAG . Assume that for  the WRS graph  is the moral graph of a DAG , we want to show that the WRS graph  is the moral graph of a DAG .

By definition, if a graph  is WRS, then it has a simplicial vertex u and an edge set 
 (possibly empty) such that 
 is also WRS. For example, in Fig. A.1b, the graph  is WRS which can be verified by showing that the subgraph 
 is also WRS, where the simplicial vertex 
 and the edge set 
. By the inductive assumption, any WRS graph  is the moral graph of a DAG . Hence, adding 
 to  and connecting it to 
 (which are 
's neighbours in ) as a sink produces a new DAG , whose moral graph is . □

Lemma A.3 Lemma 4.4

Let G be a moral graph with maximum degree 4. If a vertex x is simplicial in G and its degree 
, then the subgraph 
 is moral.

Proof

If the vertex x has degree 
, then it is a leaf in G and can be removed without causing any issues in the following steps. If 
, the closed neighbourhood  of x forms a clique and each vertex in  has degree 4. Hence, the graph 
 is a complete graph over 5 vertices because G is assumed to be a connected graph. It remains to prove the lemma when x is a degree 3 simplicial vertex.

Suppose the neighbourhood of x is 
. The fact that x is simplicial implies that each neighbour of x has degree at least 3. The maximum degree 4 assumption of G ensures their degree is at most 4. If each pair of x's neighbours have common neighbours only in 
, then the subgraph 
 is moral by Lemma 4.2. If a pair of x's neighbours  have a common neighbour y that is not in 
 as shown in Fig. A.2, then both u and v have degree 4. The only chance that the subgraph 
 that is obtained by removing from G the vertex x and the edge set 
 is not moral is when the 3-clique over  shares an edge with a cycle 
 for , but is broken after removing 
. Given x is set to have degree 3 and  reach the maximum degree 4, such a cycle (if exists) is only adjacent to the vertices w and y. If this is the case, the deletion of 
 will break this cycle and hence the 3-clique over  can be broken too without causing any issues in the following steps. Therefore, the subgraph 
 is moral. □

Fig. A.2
Download : Download high-res image (15KB)
Download : Download full-size image
Fig. A.2. A maximum degree 4 graph. The vertex x is simplicial with three neighbours u,v,w. The vertices u,v have a common neighbour that is not in the closed neighbourhood NG[x].

Appendix B. Algorithms for checking WRS
Algorithm 1 presents pseudocode for checking morality of graphs with maximum degree 3. Its computational complexity is .

Algorithm 2 presents pseudocode for checking morality of graphs with maximum degree 4. Its computational complexity is 
.

Appendix C. Proof of NP-complete
Theorem C.1 Theorem 4.3

The problem of deciding morality for maximum degree 5 graphs is NP-complete.

Proof

A variable in a 3CNF formula takes either TRUE or FALSE but not both values simultaneously. Hence, a variable gadget must be a graph that looks different when taking different values. Fig. C.1 is the variable gadget used in [13]. It contains two isomorphic subgraphs (but with different labels), one for the variable 
 and one for its negation 
. Later in the proof, this gadget is connected to other gadgets via the vertices 
 and 
, in which case 
 and 
 are the only simplicial vertices in this gadget. The purpose of the edge 
 is to avoid the upper and lower subgraphs having the same sequence of eliminations that will result in isomorphic sub-DAGs.

Fig. C.1
Download : Download high-res image (84KB)
Download : Download full-size image
Fig. C.1. A variable gadget for the variable vi in a formula ϕ. It contains two subgraphs, where the top corresponds to the literal vi and the bottom corresponds to the literal 
. The edge 
 ensures that when the vertices 
 and 
 are not simplicial and the elimination process starts from neither the vertex 
 nor 
, only one of 
 and 
 can be eliminated.

A clause in a formula is either TRUE or FALSE, depending on the values of its literals. Each clause of a 3CNF formula contains at most 3 literals. For simplicity, we only explain here the case when each clause takes exactly 3 literals. Since a clause is a disjunction of literals, it is TRUE when one literal is TRUE. Fig. C.2 is the clause gadget used in [13]. Each of the three subgraphs on the left corresponds to a literal. The isomorphism (up to labelling) of these literals indicates all of them can take the same value simultaneously. All three subgraphs are connected to a 4-clique that simulates the disjunction operation.

Fig. C.2
Download : Download high-res image (68KB)
Download : Download full-size image
Fig. C.2. A clause gadget for a clause ci in a formula ϕ. It consists of three isomorphic subgraphs (up to labelling), one for each literal in ci and a 4-clique to simulate the disjunctive operation.

The auxiliary gadgets help obtain the desired graph. The auxiliary gadget 1 shown in Fig. C.3a is the smallest moral graph that has exactly one simplicial vertex. The auxiliary gadget 2 is a path of length  that is used to connect all the clause gadgets together, where m is the number of clauses in the formula ϕ. This is different from what Verma and Pearl [13] used to avoid a vertex with degree m in their work.

Fig. C.3
Download : Download high-res image (18KB)
Download : Download full-size image
Fig. C.3. Two auxiliary gadgets assist to connect all the gadgets together to obtain a desired graph. Auxiliary gadget 2 contains m + 2 vertices, where m is the number of clauses in a formula ϕ for the 3CNF problem.

Given a 3CNF formula ϕ with n variables and m clauses, our construction will build a graph with  vertices. These vertices are made of 32 vertices from each of the n variable gadgets, 22 vertices from each of the m clause gadgets and  vertices from the two auxiliary gadgets. The gadgets are connected together to build a connected graph in the following ways:

1.
all the variable gadgets are connected together by the edges 
 for ,

2.
the auxiliary gadget 1 is connected to the first variable gadget by the edge 
 and the auxiliary gadget 2 is connected to the last variable gadget by the edge 
,

3.
the clause gadgets are connected together via the auxiliary gadget 2 by the edge 
 for each ,

4.
if a literal 
 appears in only one clause 
 in the formula ϕ, then connect the corresponding variable and clause gadgets by the edge 
 when 
 is the 
 element in the clause for ,

5.
if 
 appears in more than one clauses, say in clauses 
 as their 
 element respectively for 
, then connect the corresponding clause gadgets by the edges 
 and connect them to 
's gadget by the edge 
,

Fig. C.4 is an example of a graph that is constructed from a satisfiable 3CNF formula. The first two steps are as in [13]. Step 3 connects all the clause gadgets by a path of length equal to the number of clauses in ϕ in order to avoid high degree vertex in auxiliary gadget 2. Steps 4 and 5 first connect all clause gadgets that contain the same literal together as a ‘path’ and then connect one end of this ‘path’ to the corresponding variable gadget in order to avoid the vertices 
 and 
 having arbitrary high degrees. According to Verma and Pearl [13], the vertices that have degrees more than 5 are 
, 
 and 
 equals to the number of times 
 and 
 respectively appears in the formula ϕ. By the construction described above, these vertices are guaranteed to have degrees no more than 5.
Fig. C.4
Download : Download high-res image (199KB)
Download : Download full-size image
Fig. C.4. The reduction from a satisfiable 3-CNF 
 to a moral graph with maximum degree 5. From top to bottom, the variable gadgets are for X,Y,Z and the clause gadgets are for F1,F2,F3,F4.

The reduction from a 3CNF formula ϕ to the desired graph G is clearly in polynomial time. It remains to show that ϕ is satisfiable if and only if G is moral. The way the gadgets are connected implies that the graph G can only be eliminated perfectly starting from the variable gadgets. Due to the edge 
, the elimination will go through either the vertex 
 or 
 but not both. Suppose it goes through 
, then the subgraph that corresponds to the variable 
 in each clause gadget that is connected to the vertex 
 will be eliminated. In such a case, we say that the clause is satisfied by the literal 
, otherwise it is satisfied by the literal 
. If a formula ϕ is satisfiable, then every clause is satisfied by a literal. This implies that the 4-clique in every clause gadget in the graph G can be eliminated and consequently G can be perfectly eliminated completely. If a formula ϕ is not satisfiable, then there is a clause that cannot be satisfied by any assignments to the variables. Hence, the corresponding clause gadget cannot be eliminated at all and consequently stops the elimination process to go back to the variable gadgets from the vertex 
. Therefore, the graph G is not moral. □