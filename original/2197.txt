Low-light image enhancement is challenging in that it needs to consider not only brightness recovery but also complex issues like color distortion and noise, which usually hide in the dark. Simply adjusting the brightness of a low-light image will inevitably amplify those artifacts. To address this difficult problem, this paper proposes a novel end-to-end attention-guided method based on multi-branch convolutional neural network. To this end, we first construct a synthetic dataset with carefully designed low-light simulation strategies. The dataset is much larger and more diverse than existing ones. With the new dataset for training, our method learns two attention maps to guide the brightness enhancement and denoising tasks respectively. The first attention map distinguishes underexposed regions from well lit regions, and the second attention map distinguishes noises from real textures. With their guidance, the proposed multi-branch decomposition-and-fusion enhancement network works in an input adaptive way. Moreover, a reinforcement-net further enhances color and contrast of the output image. Extensive experiments on multiple datasets demonstrate that our method can produce high fidelity enhancement results for low-light images and outperforms the current state-of-the-art methods by a large margin both quantitatively and visually.
Introduction
Images captured in insufficiently illuminated environment usually contain undesired degradations, such as poor visibility, low contrast, unexpected noise, etc. Resolving these degradations and converting low-quality low-light images to normally exposed high-quality images require well developed low-light enhancement techniques. Such a technique has a wide range of applications. For example, it can be used in consumer photography to help the users capture appealing images in the low-light environment. It is also useful for a variety of intelligent systems, e.g., automated driving and video surveillance, to capture high-quality inputs under low-light conditions.

Low-light image enhancement is still a challenging task, since it needs to manipulate color, contrast, brightness and noise simultaneously given the low quality input only. Although numbers of methods have been proposed for this task in recent years, there is still large room for improvement. Figure 1 shows some limitations of existing methods, which follow typical assumptions of histogram equalization (HE) and Retinex theory Land (1977). HE-based methods aim to increase the contrast by simply stretching the dynamic range of images, while Retinex-based methods recover the contrast by using the estimated illumination map. Mostly, they focus on restoring brightness and contrast and ignore the influences of noise. However, in reality, the noise is inevitable and non-negligible in the low-light images, especially after increasing brightness and contrast.

To suppress the low-light image noise, some methods directly include a denoising process as a separate component in their enhancement pipeline. However, it is dilemma to make a simple cascade of the denoising and enhancement procedures. In particular, applying denoising before enhancement will result in blurring, while applying enhancement before denoising will cause noise amplification. Therefore, in this paper, we propose to model and solve the denoising and low-light enhancement problems simultaneously.

Specifically, this paper proposes an attention-guided enhancement solution that achieves denoising and enhancing simultaneously and effectively. We find that the severity of low brightness/contrast and high image noise show certain spatial distributions related to the underexposed areas. Therefore, the key is to handle the problem in a region-aware adaptive manner. To this end, we propose the under-exposed (ue) attention map to evaluate the degree of underexposure. It guides the method to pay more attention to the underexposed areas in low light enhancement. In addition, based on the ue-attention map, we derive the noise map to guide the denoising according to the joint distribution of exposure and noise intensity. Subsequently, we design a multi-branch CNN to simultaneously achieve low-light enhancement and denoising under the guidance of both maps. In the final step, we add a fully-convolutional network for improving the image contrast, exposure and color as the second enhancement.

The remaining difficulty lies in the lack of large-scale paired low-light image dataset, making it challenging to train an effective network. To address this issue, we propose a low-light image simulation pipeline to synthesize realistic low-light images with well exposed ground truth images. Image contrast and color are also improved to provide good references for our image re-enhancement step. Following the above ideas, we propose a large-scale low-light image dataset as an efficient benchmark for low-light enhancement researches.

Overall, our contributions are in three folds: (1) We propose a full pipeline for low-light image simulation with high fidelity, based on which we build a new large-scale paired low-light image dataset to support low-light enhancement researches. (2) We propose an attention-guided enhancement method and the corresponding multi-branch network architecture. Guided by the ue-attention map and noise map, the proposed method achieves low-light enhancement and denoising simultaneously and effectively. (3) Comprehensive experiments have been conducted and the experiment results demonstrate that our method outperforms state-of-the-art methods by a large margin.

Related Work
Image enhancement and denoising have been studied for a long time. In this section, we will briefly overview the most related methods.

Traditional Enhancement Methods
Traditional methods can be mainly divided into two categories. The first category is built upon the histogram equalization (HE) technique. The differences of different HE-based methods are using different additional priors and constraints. In particular, BPDHE Ibrahim and Kong (2007) tries to preserve image brightness dynamically; Arici et al. (2009) propose to analyze and penalize the unnatural visual effects for better visual quality; DHECI Nakai et al. (2013) introduces and uses the differential gray-level histogram; CVC Celik and Tjahjadi (2011) uses the interpixel contextual information; LDR Lee et al. (2013) focuses on the layered difference representation of 2D histogram to try to enlarge the gray-level differences between adjacent pixels. These methods expand the dynamic range and focus on improving the contrast of the entire image instead of considering the illumination. They may cause the problem of over- and under-enhancement.

The other category is based on the Retinex theory (Land 1977), which assumes that an image is composed of reflection and illumination. Typical methods, e.g., MSR (Jobson et al. 1997) and SSR (Jobson et al. 1997), try to recover and use the illumination map for low-light image enhancement. Recently, AMSR (Lee et al. 2013) proposes a weighting strategy based on SSR. NPE (Wang et al. 2013) balances the enhancement level and image naturalness to avoid over-enhancement. MF (Fu et al. 2016) processes the illumination map in a multi-scale fashion to improve the local contrast and maintain naturalness. SRIE (Fu et al. 2016) develops a weighted vibrational model for illumination map estimation. LIME Guo et al. (2017) develops a structure-aware smoothing model to estimate the illumination map. BIMEF Ying et al. (2017) proposes a dual-exposure fusion algorithm and Ying et al. (2017) use the camera response model for further enhancement. Li et al. (2018) propose a robust Retinex model by considering the noise map for enhancing low-light images accompanied by intensive noise. However, the key to these Retinex-based methods is the estimation of the illumination map, which is hand-crafted and relied on careful parameters tuning. Besides, most of these Retinex-based methods do not consider noise removal and often amplify the noise.

Learning-Based Enhancement Methods
Recently, deep learning has achieved great success in the field of low-level image processing (Sharma et al. 2018) and nighttime scenes modeling (Radenovic et al. 2016; Zheng et al. 2020) and understanding (Dai et al. 2018; Sakaridis et al. 2019). Powerful tools such as end-to-end networks and GANs (Goodfellow et al. 2014) have been used in image enhancement. LLNet (Lore et al. 2017) uses the multilayer perception auto-encoder for low-light image enhancement and denoising. HDRNet (Gharbi et al. 2017) learns to make local, global, and content-dependent decisions to approximate the desired image transformation. LLCNN (Tao et al. 2017) and (Tao et al. 2017) rely on some traditional methods and are not end-to-end solutions to handle brightness/contrast enhancement and denoising simultaneously. MSRNet (Shen et al. 2017) learns an end-to-end mapping between dark/bright images by using different Gaussian convolution kernels. MBLLEN (Lv et al. 2018) introduces a multi-branch network architecture to learn the mapping from low-light images to normal light ones. The method is only tested on synthetic data obtained via simple data simulations. Similar to Lv et al. (2020), our work also adopts a multi-branch network architecture. However, our novelty lies in more sophisticatedly designed techniques such as two attention guidances and the reinforce-net. A new and more complete low-light data synthesis pipeline is also introduced in this paper. Retinex-Net Wei et al. (2018) combines the Retinex theory with CNN to estimate the illumination map and enhance the low-light images by adjusting the illumination map. Similarly, KinD Zhang et al. (2019) designs a similar network by adding a Restoration-Net for noise removal. Ren et al. (2019) propose a novel hybrid network contains a content stream and a salient edge stream for low-light image enhancement. Lv et al. (2020) proposes a light-weight model with high processing speed. DeepUPE (Wang et al. 2019) proposes a network for enhancing underexposed images by estimating an image-to-illumination mapping. However, it does not consider the low-light noise.

Fig. 1
figure 1
Low-light enhancement example. Comparing with existing methods, our method can generate results with satisfactory visibility, natural color, and higher contrast

Full size image
Besides, DPED (Ignatov et al. 2017; de Stoutz et al. 2018) proposes an end-to-end approach using a composite perceptual error function for translating low-quality mobile phone photos into DSLR-quality photos. PPCN (Hui et al. 2018) designs a compact network and combines teacher-student information transfer to reduce computational cost. WESPE Ignatov et al. (2018) proposes a weakly-supervised method to overcome the restrictions on requiring paired images. Also, Chen et al. (2018) propose an unpaired learning method for image enhancement by improving two-way GANs. As for extremely low-light scenes, SID (Chen et al. 2018) develops a CNN-based pipeline to directly process raw sensor images. Lv et al. (2020) propose an enhancement solution by separating the visible and near-infrared signal from a single image and fusing them for high-quality images. The near-infared signal can be also obtained by using (Lv et al. 2019). Most of these learning-based methods do not explicitly contain the denoising process, and some even rely on traditional denoising methods. However, our approach considers the effects of noise and uses two attention maps to guide the enhancing and denoising process. So, our method is complementary to existing learning-based methods.

Image Denoising Methods
Existing works for image denoising are massive. For Gaussian denoising, BM3D (Dabov et al. 2006) and DnCNN (Zhang et al. 2017) are representatives of the filter-based and deep-learning-based methods. For Poisson denoising, NLPCA (Salmon et al. 2014) combines elements of dictionary learning with sparse patch-based representations of images and employs an adaptation of Principal Component Analysis. Azzari and Foi (2016) propose an iterative algorithm combined with variance-stablizing transformation (VST) and BM3D filter (Dabov et al. 2006). DenoiseNet (Remez et al. 2017) uses a deep convolutional network to calculate the negative noise components, which adds directly to the original noisy image to remove Poisson noise. For Gaussian-Poisson mixed denoising, CBDNet (Guo et al. 2019) presents a convolutional blind denoising network by incorporating asymmetric learning. It is applicable to real noise images by training on both synthetic and real images. For real-world image denoising, TWSC (Xu et al. 2018) develops a trilateral weighted sparse coding scheme. Chen et al. (2018) propose a two-step framework which contains noise distribution estimation using GANs and denoising using CNNs. Directly combining these methods with enhancement methods will result in blurring. To avoid this, our solution performs enhancing and denoising simultaneously.

Low-Light Image Enhancement Datasets
Some traditional low-light enhancement works (Wang et al. 2013; Ying et al. 2017) use unpaired low-light images or High Dynamic Range (HDR) dataset, like MEF dataset (Ma et al. 2015), for testing. However, these datasets are in small scale and contain limited scenes, which cannot be used for training. Recently, several paired datasets are constructed by manually capturing paired low-light and normal-light images. Multiple shootings with different camera configurations or retouching captured images are the two main solutions. The LOL (Wei et al. 2018) and SID (Chen et al. 2018) datasets are constructed using the former solution. Images in the LOL dataset are captured in the daytime by controlling the exposure and ISO. Meanwhile, the underexposed images are generated by linear degradation approximately, which may differ from real cases. This will result in performance variation in low-light image enhancement (see the result of RetinexNet in Fig. 1). The SID dataset is composed of raw sensor data under extremely low-light night scenes (0.2β€“5 lux), which is different from those used in general low-light (>10 lux) image enhancement researches. As for the latter solution, the DeepUPE (Wang et al. 2019) dataset collects 3,000 underexposed images, each with an expert-retouched reference. However, the under-exposed levels of the images are relatively low, which may not cover the heavily low-light scenes. Besides, the SICE (Cai et al. 2018) dataset collects multi-exposed image sequences and uses the Exposure Fusion methods to construct the reference image under the supervision of human. However, imperfect alignment of image sequences will result in blur and ghosting. Although these datasets have made great contributions to the field of low-light image enhancement, they still show limitations. On one hand, their data amounts are relatively small with respect to the number of images. Since the variation of scenes and light conditions are limited, the trained models may not be generalized well in many cases. On the other hand, due to the lack of annotations, these datasets are difficult to be used for other relevant vision tasks, such as detection and segmentation in the dark.

Large Scale Low-Light Simulation Dataset
In this paper, we propose an effective low-light simulation method to synthesize low-light images from normal-light images. The purpose is to offer a large diversity in scenes and light conditions which is required by our method and other further researches. Many previous works (Hahner et al. 2019; Sakaridis et al. 2018) have proven that the synthetic data is an effective alternative to real data in different vision tasks. Using synthetic data allows easy model adaptation for target conditions without requiring additional manual annotations (Dai et al. 2019; Sakaridis et al. 2018). Similarly, we believe that generating synthetic low-light image datasets from public datasets (Bileschi 2006; Everingham et al. 2010; Grubinger et al. 2006; Lin et al. 2014) with rich annotations also has the potential to achieve model adaptation in low-light conditions. The proposed dataset construction pipeline is shown in Fig. 3.

Fig. 2
figure 2
Samples of large-scale public datasets: (left) low-quality examples, (right) high-quality examples

Full size image
Fig. 3
figure 3
Pipeline of constructing the proposed low-light simulation dataset. Our method optimally selects normal exposed images from public datasets, performs low-light simulation, and adds noise to synthesize realistic low-light images. Meanwhile, the original normal exposed images are enhanced by exposure correction and contrast/details amplification, so as to generate better reference images. Details can be found in Sect. 3

Full size image
Candidate Image Selection
Our proposed low-light image simulation pipeline requires high-quality normally exposed images as the input. Therefore, we need to distinguish such high-quality images from low-quality ones given large-scale public image datasets, as shown in Fig. 2. To this end, we propose a candidate image selection method which takes the proper exposure, rich color, blur-free and rich details into account. The selection method contains three steps: darkness estimation, blur estimation and color estimation.

Darkness Estimation
To select images with sufficient exposure values, we use over-segmentation (Achanta et al. 2012) and calculate the mean/variance of the V component in HSV color space based on the segmentation results. If the calculated mean/variance is larger than thresholds 0.15/0.001, we set this segmentation block to be sufficiently exposed. Finally, images with more than 85% sufficiently bright blocks are selected as candidates.

Blur Estimation
This stage aims to select unblurred images with rich details. Following the same pipeline in Pech-Pacheco et al. (2000), we apply the Laplacian edge extraction, calculate the variance among all the output pixels and use a threshold 500 to determine whether this image can be selected.

Color Estimation
We directly estimate the color according to Hasler and Suesstrunk (2003) to select images with rich color. A threshold is set to 500 to eliminate those low-quality, gray-scale or unnatural images.

To ensure diversity, we select 22, 656 images from a total of 344, 272 images (collected from public datasets (Bileschi 2006; Everingham et al. 2010; Grubinger et al. 2006; Lin et al. 2014)) based on the above rules to build the dataset. And We randomly select 965 images as the test set.

Target Image Synthesis
We propose a low-light image simulation method to synthesize realistic low-light images from normal-light images, as shown in Fig. 3. This produces an adequate number of paired low/normal light images which are needed for training of learning-based methods.

Low-Light Image Synthesis
Low-light images differ from normal images due to two dominant features: low brightness/contrast and the presence of noise. Other sensor specific or image signal processor (ISP) specific degradations are beyond the scope of this paper. In our low-light image synthesis, we first try to fit a transformation to covert the normal image to the underexposed low-light image. By analyzing images with different degree of exposure, we find that the combination of linear and gamma transformation can approximate this job well. To verify this, we test on multi-exposure images and use the histogram of Y channel in YCbCr color space as the metric. As shown in Fig. 4, the synthetic under-exposed images are approximately the same to real low-light images, which is also been proven by Ying et al. (2017). The low-light image simulation pipeline (without additional noise) can be formulated as:

πΌ(π‘–)π‘Ά=π›½Γ—(π›ΌΓ—πΌ(π‘–)π‘)π›Ύ,π‘–β{π‘…,πΊ,πµ}.
(1)
where πΌπ‘ is the image selected from public datasets with o indicating β€originalβ€. πΌπ‘Ά is the the synthetic under-exposed image with u indicating β€underexposedβ€. π›Ό and π›½ are linear transformations. The (β‹…)π›Ύ means the gamma transformation. The three parameters is sampled from uniform distribution: π›ΌβΌπ‘(0.9,1), π›½βΌπ‘(0.5,1), π›ΎβΌπ‘(1.5,5).

Fig. 4
figure 4
Verification of the low-light simulation method: visual comparison and the histogram of Y channel in YCbCr between synthetic images and real different exposure images

Full size image
Table 1 Comparison with existing low-light enhancement datasets. H(eavy), M(edium) and S(light) means the underexposed level
Full size table
As for the noise, many previous methods fail to consider, while our method takes it into account. In particular, we follow (Guo et al. 2019; Yamashita et al. 2017; Wang et al. 2019) to use the Gaussian-Poisson mixed noise model and take the in-camera image processing pipeline into account to simulate real low-light noise. The noise model can be formulated as:

πΌπ‘™=π‘“(π‘€β’1(ξΌ(π‘€(π‘“β’1(πΌπ‘Ά)))+π‘πΊ)),
(2)
where πΌπ‘™ is the synthetic low-light image with l indicating β€low-lightβ€. πΌπ‘Ά is the synthetic under-exposed image with u indicating β€underexposedβ€. ξΌ(β‹…) represents adding Poisson noise. π‘πΊ is modeled as AWGN with noise variance π2π‘”. π‘“(β‹…) stands for the camera response function. π‘€(β‹…) is the function that convert RGB images to Bayer images and π‘€β’1(β‹…) is the demosaicing function. In our experiments, π‘“(β‹…) are uniformly sampled from 201 CRFs provided in Grossberg and Nayar (2004) and π‘€(β‹…) represents the demosaicing function proposed in Malvar et al. (2004). We do not consider compression in this paper.

Fig. 5
figure 5
Comparison with existing paired low-light datasets. Top: Example images of different datasets. Bottom: All the exposure adjustment curves (tone curve) for different datasets. Each colored curve represents the transform curve to turn a low light case to its corresponding ground truth. Deeper curve indicates a darker light condition where more enhancement is needed. Our dataset has a wider range of curves which shows the coverage of light condition is wider in our dataset

Full size image
Fig. 6
figure 6
The proposed network with four subnets. The Attention-Net and Noise-Net are used to estimate the attention of exposure and noise. The Enhancement-Net and Reinforce-Net are corresponding to the two enhancement processes. The core network is the multi-branch Enhancement-Net, which is composed of feature extraction module (FEM), enhancement module (EM) and fusion module (FM). The dashed lines represent skip connections and the circles represent copy operation

Full size image
Image Contrast Amplification
Directly using the selected candidate image from the public datasets as the reference for training a low-light enhancer may result in low-contrast results (see the results of MBLLEN Lv et al. (2018) in Fig. 9, which is trained directly using the images of PASCAL VOC dataset (Everingham et al. 2010) as the reference). As these datasets are not initially designed for the low-light enhancement task, the corresponding image brightness and contrast levels are not well controlled during capturing. This makes these datasets unsuitable for training an efficient low-light enhancer.

In order to make use of them, these images need to be corrected first in terms of color and contrast. Therefore, we propose to use a contrast amplification method as the post-processing step to correct the uneven quality (e.g., low contrast) in public dataset and improve the visual quality to build better ground truth.

In particular, we apply exposure fusion to improve the contrast/color and correct the exposure. First, we use gamma transforms to synthesize 10 images with different exposure settings and saturation levels from each original image. Subsequently, we fuse these differently exposed images following the same routine in Mertens et al. (2007) (the results called colorful images). Finally, we apply image smoothing Xu et al. (2011) to further enhance the image details. The final output images called high-contrast images that can be used as ground truth to train a visually better low-light enhancement network.

Comparison of Low-Light Enhancement Datasets
There are some existing datasets for low-light image enhancement. However, these datasets still have their own limitations. In this section, we highlight the differences between our synthetic dataset and other low-light image enhancement datasets, to show that our synthetic dataset is a good complement to existing datasets. The characteristics of different datasets are summarized in Table 1.

Scale and Diversity
Having a large dataset with diverse scenes and lighting conditions is significant for training a model that can generalize well. Manually collecting images or editing images as in other datasets is a costly process, which make them hard to acquire data at scale. Therefore, existing datasets are all relatively small in size. In contrast, as our data generation is based on simulation, our method can synthesize paired low-light and normal light images as much as needed for different scenes.

Low-Light Level
Covering a large range of low-light conditions is another important factor for the generalization capabilities of the trained models. To illustrate the range of different under-exposed levels, we calculate the exposure adjustment curve, which is the transform to the luminance channel of the low-light image (the V component in HSV color space) to make the luminance histogram match that of reference ground truth image. The estimated curve can serve as an estimation of the under-exposure levels, that is, steeper change of the curve indicates higher under-exposure levels. The exposure adjustment curves for all data pair in each dataset are shown in Fig. 5. The shape of the exposure adjustment curves represents the low-light level while the coverage of the curves means the diversity of light conditions. For the shape of the curve, our dataset is close to the real low-light datasets (like LOL (Wei et al. 2018) and SCIE (Cai et al. 2018)), which demonstrates that our synthetic low-light images are realistic as captured low-light images. Specifically, the deep curves show that the LOL (Wei et al. 2018) dataset contains many heavy low-light images. The DeepUPE (Wang et al. 2019) dataset mainly covers medium under-exposure levels. As for the SICE (Cai et al. 2018) dataset, the under-exposure degree is sparse, which is caused by its specific exposure pre-settings. Note that, in this research, we use the medium exposed images as the ground truth to estimate the curves for SICE (Cai et al. 2018) dataset. In contrast, our synthetic dataset contains a large variety of under-exposure levels, which is useful for improving the generalization capabilities of our trained models. From this dimension, our synthetic low-light dataset has advantages over real low-light datasets as they may be affected by discrete values such as ISO and exposure times.

Quality
For learning-based methods, the quality of images is crucial as it directly decides the performance of training models. SCIE Cai et al. (2018) uses multi-exposure image fusion result as the ground truth, which inevitably contains ghosting and blur. SID Chen et al. (2018) prolongs exposure time to obtain high-quality night images, which may cause local overexposure and blur. LOL Wei et al. (2018) captures paired images by adjusting the ISO, which results in the exposure adjustment being approximately linear. In many cases, simply increasing low-light images linearly can result in good results. As for DeepUPE Wang et al. (2019), using retouched images as the ground truth does not have the ability to deal with noise and artifacts. In contrast, our synthetic dataset does not have these problems. Besides, it provides the noise distribution map and exposure map that can be used as supervision to improve the performance of the trained model.

Compatibility
Beside making the visual quality more appealing, improving the performance of other vision systems under low-light conditions is another important application for low-light enhancement. However, existing datasets do not contains manual annotations as they are only designed for visual quality enhancement. In contrast, our proposed simulation method can leverage existing public datasets with rich annotations to generate training data in low-light conditions. Specifically, we can apply our simulation to popular datasets (e.g., COCO Lin et al. (2014)) to render realistic low-light images and retain their corresponding annotations. (e.g., bounding boxes for object detection, label maps for semantic segmentation, etc.) Previous works (Dai et al. 2019; Sakaridis et al. 2018) have proven that synthetic data is useful for model adaptation under adverse conditions. Thus, our synthetic dataset also has potential ability to improve the performance of fundamental vision methods to handle low-light conditions, such as object detection and semantic segmentation, etc.

In summary, our synthetic dataset has many advantages over existing datasets. Our synthetic dataset contains high quality paired pixel-aligned images with various scenes, diverse lighting conditions, and different underexposed levels. Moreover, this simulation can be applied to datasets with annotations, which is useful for model adaptation under low-light conditions. Our synthetic dataset is an important complement to existing low-light enhancement datasets.

Attention-Guided Low-Light Enhancement
In this section, we introduce the proposed attention-guided enhancement solution, including the network architecture, the loss function and the implementation details.

Network Architecture
We propose a fully convolutional network containing four subnets: an Attention-Net, a Noise-Net, an Enhancement Net and a Reinforce-Net. Figure 6 shows the overall network architecture. The Attention-Net is designed for estimating the illumination to guide the method to pay more attention to the underexposed areas in enhancement. Similarly, the Noise-Net is designed to guide the denoising process. Under their guidance, the multi-branch Enhancement-Net can perform enhancing and denoising simultaneously. The Reinforce-Net is designed for contrast re-enhancement to solve the low-contrast limitation caused by regression. The detailed description is provided below.

Attention-Net
We directly adopt U-Net in our implementation. The motivation is to provide a guidance to let Enhancement-Net correctly enhance the underexposed areas and avoid over-enhance the normally exposed areas. The output is an ue-attention map indicating the regional under-exposure level, as shown in Fig. 7. The higher the illumination is, the lower ue-attention map values are. The ue-attention mapβ€™s value range is [0, 1] and is determined by:

π΄=|π‘π‘π‘¥π‘(πΌπ‘)β’π‘π‘π‘¥π‘(πΌπ‘Ά)|π‘π‘π‘¥π‘(πΌπ‘),
(3)
where π‘π‘π‘¥π‘(β‹…) returns the maximum value among three color channels with c indicating β€channelβ€. A is the expected attention map. πΌπ‘ is the original image selected from public datasets and πΌπ‘Ά is the corresponding synthetic under exposed image.

Essentially, the ue-attention map is the estimation of the under-exposure level of the low-light images. It shares some of the properties of the illumination map in Retinex model. As shown in Fig. 7, our learned ue-attention map is correlated with the illumination map. However, directly using our inverted ue-attention map according to the Retinex model cannot ensure satisfactory results. This is because the Retinex-based solution faces difficulties in handling black regions (see black regions in Fig. 1) and will result in noise amplification (see LIME results in Fig. 11). Therefore, we propose to use the ue-attention map as a guidance for our Enhancement Net introduced later.

Fig. 7
figure 7
Comparison between our ue-attention map and the illumination maps used for retinex-based methods. Our ue-attention map can generate similar illumination information with more details

Full size image
Noise-Net
The image noise can be easily confused with image textures, causing unwanted blurring effect after applying simple denoising methods. Estimating the noise distribution beforehand and making the denoising adaptive may help reduce such an effect. The noise mapβ€™s value range is [0, 1] and is determined by:

π‘=π‘π‘π‘¥π‘(|πΌπ‘™β’πΌπ‘Ά|πΌπ‘Ά),
(4)
where π‘π‘π‘¥π‘(β‹…) returns the maximum value among three color channels. N is the expected noise map. πΌπ‘™ and πΌπ‘Ά represent the synthetic low-light image and the synthetic under exposed image.

Note that the noise distribution is highly related to the distribution of exposure, and thus we propose to use the ue-attention map to help derive a noise map. Under their guidance, the enhancement-net can perform denoising effectively. The Noise-Net is composed of dilated convolutional layers to increase the receptive field, which is conducive to noise estimation inspired by the work of DnCNN Zhang et al. (2017) and BRDNet Tian et al. (2020).

Enhancement-Net
The motivation is to decompose the enhancement problem into several sub-problems of different aspects (such as noise removal, texture preserving, color correction and so on) and solve them respectively to produce the final output via multi-branch fusion. It is the core component of the proposed network and it consists of three types of modules: the feature extraction module (FEM), the enhancement module (EM) and the fusion module (FM). FEM is a single stream network with several convolutional layers, each of which uses 3Γ—3 kernels, stride of 1 and ReLU nonlinearity. The output of each layer is both the input to the next layer and also the input to the corresponding subnet of EM. EMs are modules following each convolutional layer of the FEM. The input to EM is the output of a certain layer in FEM, and the output size is the same as the input. FM accepts the outputs of all EMs to produce the final enhanced image. We concatenate all the outputs from EMs in the color channel dimension and use the 1Γ—1 convolution kernel to merge them, which equals to the weighted summation with learnable weights.

Inspired by the DeepUPE Wang et al. (2019), we propose five different EM structures with different receptive fields, which is helpful to obtain multi-scale information. As shown in Fig. 6, the design of EM follows U-Net Ronneberger et al. (2015) and Res-Net He et al. (2016) which have been proven effective extensively. In brief, EM-1 is a stack of convolutional and deconvolutional layers with large kernel size. EM-2 and EM-3 has U-Net like structures, and the difference is the skip connection realization and the feature map size. EM-4 has a Res-Net like structure. We remove the Batch-Normalization (Ioffe and Szegedy 2015) and use just a few res-blocks to reduce the model parameter. EM-5 is composed of dilated convolutional layers whose output size is the same as the input.

Reinforce-Net
The motivation is to overcome the low-contrast drawback and improve the details (see the difference between MBLLEN Lv et al. (2018) and ours in Fig. 9). Previous research Chen et al. (2017) demonstrates the effectiveness of dilated convolution in image processing. Therefore, we use a similar network to improve contrast and details simultaneously.

Loss Function
In order to improve the image quality both qualitatively and quantitatively, we propose a new loss function by further considering the structural information, perceptual information and regional difference of the image. It is expressed as:

ξΈ=π”π‘ξΈπ‘+π”π‘›ξΈπ‘›+π”π‘’ξΈπ‘’+π”π‘ξΈπ‘,
(5)
where the ξΈπ‘, ξΈπ‘›, ξΈπ‘’ and ξΈπ‘ represent the loss function of Attention-Net, Noise-Net, Enhancement-Net and Re-inforce-Net, and π”π‘,π”π‘›,π”π‘’,π”π‘ are the corresponding coefficients. The details of the four loss functions are given below.

Attention-Net loss
To obtain the correct ue-atte-ntion map for guiding the Enhancement-Net, we use the L2 error metric to measure the prediction error as:

ξΈπ‘=β€–ξ²π‘(πΌπ‘™)β’π΄β€–2,
(6)
where πΌπ‘™ is the synthetic low-light image with l indicating β€low-lightβ€. ξ²π‘(.) represents the Attention-Net with a indicating β€attentionβ€. ξ²π‘(πΌπ‘™) and A are the predicted and expected ue-attention maps, respectively.

Noise-Net Loss
Similarly, we use the L1 error metric to measure the prediction error of the Noise-Net as:

ξΈπ‘›=β€–ξ²π‘›(πΌπ‘™,π΄β€²)β’π‘β€–1,
(7)
where π΄β€²=ξ²π‘(πΌπ‘™) represents the predicted ue-attention map. ξ²π‘›(.) represents the Noise-Net with n indicating β€noiseβ€. ξ²π‘›(πΌπ‘™,π΄β€²) and N are the predicted and expected noise maps, respectively.

Enhancement-Net Loss
Due to the low brightness of the image, only using common error metrics such as mse or mae may cause structure distortion such as blur effect and artifacts. We design a new loss that consists of four components to improve the visual quality. It is defined as:

ξΈπ‘’=π”π‘’π‘ξΈπ‘’π‘+π”π‘’π‘ ξΈπ‘’π‘ +π”π‘’π‘ξΈπ‘’π‘+π”π‘’π‘ξΈπ‘’π‘,
(8)
where the ξΈπ‘’π‘, ξΈπ‘’π‘ , ξΈπ‘’π‘ and ξΈπ‘’π‘ represent bright loss, structural loss, perceptual loss and regional loss. And π”π‘’π‘, π”π‘’π‘ , π”π‘’π‘ and π”π‘’π‘ are the corresponding coefficients.

The bright loss is designed to ensure that the enhanced results have sufficient brightness. It is defined as:

ξΈπ‘’π‘=β€–ξΏ(ξ²π‘’(πΌπ‘™,π΄β€²,π‘β€²)β’πΌπ‘)β€–1,
(9)
where πΌπ‘™ and πΌπ‘ are the synthetic low-light image and the bright original image. π‘β€²=ξ²π‘›(πΌπ‘™) is the predicted noise map. ξ²π‘’(.) is the Enhancement-Net with e indicating β€enhancementβ€. ξ²π‘’(πΌπ‘™,π΄β€²,π‘β€²) is the predicted enhancement images. ξΏ(β‹…) is defined as: given a constant π†>1, if π‘¥<0, ξΏ(π‘¥)=β’π†π‘¥, otherwise ξΏ(π‘¥)=π‘¥.

The structural loss is introduced to preserve the image structure and avoid blurring. We use the well-known image quality assessment algorithm SSIM Wang et al. (2004) to build our structure loss. The structural loss is defined as:

ξΈπ‘’π‘ =1β’1π‘β‘π‘βπ‘–π‘π‘”2π‡π‘¥π‡π‘¦+π¶1π‡2π‘¥+π‡2π‘¦+π¶1β‹…2ππ‘¥π‘¦+π¶2π2π‘¥+π2π‘¦+π¶2,
(10)
where π‡π‘¥ and π‡π‘¦ are pixel value averages, π2π‘¥ and π2π‘¦ are variances, ππ‘¥π‘¦ is the covariance, and π¶1 and π¶2 are constants to prevent the denominator to zero.

The perceptual loss is introduced to use higher-level information to improve the visual quality. We use the well-behaved VGG network (Simonyan and Zisserman 2014) as the content extractor (Ledig et al. 2017). In particular, we define the perceptual loss based on the output of the ReLU activation layers of the pre-trained VGG-19 network. The perceptual loss is defined as follows:

ξΈπ‘’π‘=1π‘¤π‘–π‘—β„π‘–π‘—π‘π‘–π‘—β‘π‘¥=1π‘¤π‘–π‘—β‘π‘¦=1β„π‘–π‘—β‘π‘§=1π‘π‘–π‘—β€–π™π‘–π‘—(πΌπ‘’)π‘¥π‘¦π‘§β’π™π‘–π‘—(πΌπ‘)π‘¥π‘¦π‘§β€–,
(11)
where πΌπ‘’=ξ²π‘’(πΌπ‘™,π΄β€²,π‘β€²) is the output image of the Enhancement-Net with e indicating β€enhancementβ€. π‘¤π‘–π‘— , β„π‘–π‘— and π‘π‘–π‘— describe the dimensions of the respective feature maps within the VGG-19 network. Besides, π™π‘–π‘— indicates the feature map obtained by the j-th convolution layer in the i-th block of the VGG-19 Network.

For low-light image enhancement, except taking the image as a whole, we should pay more attention to the underexposed regions. We propose the regional loss to balances the degree of enhancement for different regions. It is defined as:

ξΈπ‘’π‘=β€–πΌπ‘’β‹…π΄β€²β’πΌπ‘β‹…π΄β€²β€–1+1β’π‘ π‘ π‘–π‘(πΌπ‘’β‹…π΄β€²,πΌπ‘β‹…π΄β€²)
(12)
where π‘ π‘ π‘–π‘(β‹…) represents the image quality assessment algorithm SSIM (Wang et al. 2004) and π΄β€²=ξ²π‘(πΌπ‘™) is the predicted ue-attention map which is used as the guidance.

Reinforce-Net Loss
Similar to the Enhancement-Net loss, the Reinforce-Net loss is defined as:

ξΈπ‘=π”π‘π‘ξΈπ‘π‘+π”π‘π‘ ξΈπ‘π‘ +π”π‘π‘ξΈπ‘π‘,
(13)
where ξΈπ‘π‘, ξΈπ‘π‘  and ξΈπ‘π‘ represent bright loss, structural loss and perceptual loss, and are the same as ξΈπ‘π‘, ξΈπ‘π‘  and ξΈπ‘π‘. Note that, we use the contrast amplified images as the reference image when calculating the loss of the Reinforce-Net. In the experiments, we empirically set π†=10, π”π‘,π”π‘›,π”π‘’,π”π‘={102,10,10,1}, π”π‘’π‘,π”π‘’π‘ ,π”π‘’π‘,π”π‘’π‘={1,1,0.35,5}, π”π‘π‘,π”π‘π‘ ,π”π‘π‘={1,1,0.35}.

Implementation Details
Our implementation is done with Keras (Chollet et al. 2015) and Tensorflow  (Abadi et al. 2016). The proposed network can be quickly converged after being trained for 20 epochs on a Titan-X GPU using the proposed dataset. In order to prevent overfitting, we use random clipping, flipping and rotating for data augmentation. We set the batch-size to 8 and the size of random clipping patches to 256Γ—256Γ—3. The input image values is scaled to [0, 1]. We use the output of the fourth convolutional layer in the third block of VGG-19 network as the perceptual loss extraction layer.

In the experiment, training is done using the Adam optimizer (Kingma and Ba 2014) with parameters of π›Ό=0.0002, π›½1=0.9, π›½2=0.999 and π–=10β’8. We also use the learning rate decay strategy, which reduces the learning rate to 98% before the next epoch. At the same time, we reduce the learning rate to 50% when the loss metric has stopped improving.

Experimental Evaluation
We compare our method with existing methods through extensive experiments. If there are no special instructions, we use the publicly-available codes with recommended parameter settings. In quantitative comparison, we used PSNR and SSIM Wang et al. (2004), along with some recently proposed metrics Average Brightness (AB) Chen et al. (2006), Visual Information Fidelity (VIF) Sheikh and Bovik (2006), Lightness Order Error (LOE) Ying et al. (2017), Tone Mapped Image Quality Index (TMQI) Yeganeh and Wang (2013) and Learned Perceptual Image Patch Similarity Metric (LPIPS)Zhang et al. (2018). For all metrics higher number means better, except LPIPS, LOE and AB. Note that in the tables below, bold, italic and bold-italic indicate the best, second, and third place results, respectively.

Our experiment is organized as following. First, we make qualitative and quantitative comparisons based on our synthetic dataset and two public-available real low-light datasets. Second, we make visual comparisons with state-of-the-art methods on natural low-light images and provide a user study. We also show the robustness of our method and the benefit to some high-level tasks. Finally, we provide an ablation study to evaluate the effect of different elements and discuss unsatisfying cases.

Table 2 Quantitative comparison of synthetic low-light image (without additional noise) enhancement
Full size table
Table 3 Quantitative comparison of synthetic low-light images (with additional noise) enhancement
Full size table
Fig. 8
figure 8
Visual comparison on synthetic low-light images. We fine tune the GLADNet Wang et al. (2018) and LLNet Lore et al. (2017) using our synthetic datasets. Please zoom in for a better view

Full size image
Fig. 9
figure 9
Visual comparison on the LOL dataset (row 1 and 2) and the SID dataset (row 3). As the input images are too dark to see the details, we show their linearly brightened version on the top-right corner. Please zoom in for a better view

Full size image
Experiments on Synthetic Datasets
Direct Comparison
We compare our method with state-of-the-art methods on our synthetic dataset. Since most methods do not have the ability to remove noise, we combine them with the state-of-the-art denoising method CBDNet Guo et al. (2019) to produce the final comparison results. We finetune the GLADNet Wang et al. (2018), MBLLEN Lv et al. (2018) and LLNet Lore et al. (2017) for a fair comparison. Quantitative comparison results are shown in Tables 2 and 3. Our result significantly outperforms other methods in all quality metrics, which fully demonstrates the superiority of our approach.

Representative results are visually shown in Fig. 8. By checking the details, it is clear that our method achieves better visual effects, including good brightness/contrast and less artifacts. Please zoom in to compare the details (Fig. 9).

Efficiency Comparison
In addition to the result quality, efficiency is also an important metric to algorithms. In order to demonstrate the superiority of our method, we use 10 HD images with size 1920Γ—1080 as the benchmark to test running time. In order to more intuitively demonstrate the relationship between performance and efficiency, we show Fig. 10. Our method performs well in terms of both quality and efficiency. Note that, JED Ren et al. (2018) and Robust Li et al. (2018) need large computational resources, which will cause out-of-memory problem when processing large images. Due to the MLP architecture, LLNet Lore et al. (2017) needs to enhance large images one patch by one patch, which will limits its efficiency.

Table 4 Quantitative comparison between our method and state-of-the-arts on the LOL dataset and the SID dataset
Full size table
Experiments on Real Datasets
Besides synthetic datasets, our method also performs well on real low-light image datasets. We evaluate the performance based on two public-available real low-light datasets and show the visual comparison on challenging images.

LOL Dataset
This dataset is captured by control the exposure and ISO in the daytime. We finetune our model using this dataset to compare with RetinexNet Wei et al. (2018). The RetinexNet Wei et al. (2018) is trained on the LOL dataset. In addition, we replace the Enhancement-Net by a standard U-Net to build a lightweight version. Following PPCN Hui et al. (2018), we use the original network as the teacher model and use the lightweight version as the student model. We adopt knowledge transfer to boost the performance of the light-weight model by using knowledge distillation loss proposed in Hui et al. (2018). Quantitative comparison is shown in Table 4. For both quality and efficiency comparisons, our method performs better, manifesting that our method effectively learns the adjustment and restoration. Visual comparison is shown in Fig. 9. Compared with RetinexNet Wei et al. (2018), KinD Zhang et al. (2019) and MBLLEN Lv et al. (2018), our results with clear details, better contrast, normal brightness and natural white balance.

SID Dataset
This dataset contains raw short-expo-sure images with corresponding long-exposure reference images and is benchmarking single-image processing of extremely low-light raw images. Due to the larger bit depth, raw images are more suitable for extremely low-light scenes compared with rgb images. Different from traditional pipelines, SID Chen et al. (2018) develop a pipeline based on an end-to-end network and achieve excellent results. Note that, processing low-light raw images is a related but not identical problem. However, to prove the ability of our multi-branch network, we use the same configuration except that the network is replaced by our Enhancement-Net. Quantitative comparison is shown in Table 4. Our model is lightweight and more efficient, but achieves comparable enhancement quality. In addition, our results have better visual effects as shown in Fig. 9.

Experiments on Real Images
In this section, we evaluate our method on real low-light images, including natural, monochrome and game scenes. We also show the benefit to object detection and semantic segmentation under low-light environment by directly using our method as the pre-processing.

Fig. 10
figure 10
Runtime and performance comparison of different enhancement methods. Test machine is a PC with Intel i5-8400 CPU, 16 GB memory and NVIDIA Titan-Xp GPU. β€*β€ represents using GPU

Full size image
Fig. 11
figure 11
Visual comparison of real low-light images, which are taken at night. These low-light scenes are selected from Dark Face dataset Yuan et al. (2019), which contains 6,000 real-world low light images captured during the nighttime. Please zoom in for a better view

Full size image
Natural Low-Light Images
We first compare our method with state-of-the-art methods on natural low-light images and the representative visual comparison results are shown in Fig. 11. Our method surpasses other methods in two key aspects. On the one hand, our method can restore vivid and natural color to make the enhancement results more realistic. In contrast, Retinex-based methods (such as RetinexNet (Wei et al. 2018) and LIME (Guo et al. 2017)) will cause different degrees of color distortion. On the other hand, our method is able to recover better contrast and more details. This improvement is especially evident when compared with LLNet (Lore et al. 2017), BIMEF (Ying et al. 2017) and MBLLEN (Lv et al. 2018).

User Study
We invite 100 participants to attend a user study to test the subjective preference of low-light image enhancement methods. We randomly select 20 natural low-light image cases and enhance them using five representative methods. For each case, the input data and the five enhanced results will be shown to the participants at the same time. We then ask the participants to rank the quality of the five enhancements from 1 (best) to 5 (worst) in terms of recovery of brightness, contrast, and color. We also provide zoom-in function to let participants to check details like texture and noises controls. The other four methods used besides ours in this study are DHECI (Nakai et al. 2013), DeepUPE (Wang et al. 2019), LIME (Guo et al. 2017) and Robust (Li et al. 2018).

Figure 12 shows the rating distribution of the user study. Our method receives more β€bestβ€ ratings, which shows that our results are more preferred by human subjects.

Fig. 12
figure 12
Rating distribution of the user study

Full size image
Fig. 13
figure 13
Generalizing our method to enhance (upper) monochrome surveillance scenes and (bottom) nighttime game scenes

Full size image
Fig. 14
figure 14
After processing the low-light scene (upper row) with our method, the performance of both object detection and instance segmentation is greatly improved (bottom row). These low-light scenes are selected from Dark Face dataset (Yuan et al. 2019), which contains 6,000 real-world low light images captured during the nighttime

Full size image
Generalization Study
To prove the robustness of our method, we directly apply our trained model to enhance some specific types of low-light scenes (such as monochrome surveillance and game night scenes) that are unseen in the training dataset. Figure 13 shows the enhancement results. The results demonstrate that our method is robust and effective for general low-light image enhancement tasks. Besides, we also show that our approach is beneficial to some high-level tasks in low-light scenes, such as object detection and instance segmentation, as shown in Fig. 14. The performance of Mask-RCNN (Abdulla 2017; He et al. 2017) has been improved a lot by using our method in a pre-processing stage without any fine-tuning.

To objectively investigate the effect of applying our method to enhance low light images for high-level vision tasks, we perform a quantitative evaluation on the Exclusively Dark dataset (Loh and Chan 2019), which is a collection of 7,363 real low-light images with 12 object classes annotated on both image class level and local object bounding boxes. The commonly used evaluation metric is the mean Average Precision (mAP) and we select two popular detectors SSD (Liu et al. 2016) and Faster-RCNN (Ren et al. 2015) to test. The results are listed in Table 5. As can be seen after enhancing the dark image using our method, the detector scores for both SSD and Faster-RCNN increase. This demonstrates that our enhancement method can benefit high-level vision tasks under low-light conditions.

Ablation Study
In this section, we quantitatively evaluate the effectiveness of different components in our method based on our synthetic low-light dataset. Table 6 reports the accuracy of the presented change in terms of PSNR and SSIM Wang et al. (2004). Note that the Reinforce-Net is not considered in this study.

Loss Functions
We mainly evaluate the loss function of the Enhancement-Net, as shown in Table 6 (row 2-5). We use mse as the naive loss function under condition 2. The results show that the quality of enhancement is improving by containing more loss components.

Network Structures
As shown in Table 6 (row 6-7), we evaluate the effectiveness of different network components. Similar to the loss function, the results demonstrate that more components of our network will result in better performance.

Number of Branches
We analyze the effect of different branch numbers (model size) on the network performance, as shown in Table 6 (row 8-9). Obviously, the increase of model size will not always improve performance, so we set 10 branches as the default configuration.

Table 5 Quantitative evaluation (mAP) of object detection in low-light scenes on the ExDark dataset Loh and Chan (2019).
Full size table
Table 6 Ablation study. This table reports the performance under each condition based on the synthetic low-light dataset.
Full size table
Unsatisfying Cases
Figure 15 presents a case where our method performs not perfectively. Our method fails to recover the face details on the top image, as some parts of the face are totally dark. Another issue is the blocking artifacts due to heavy image compression.

Fig. 15
figure 15
This image has totally dark regions where textures are lost and compressed heavily. These cause issues in the enhancement result

Full size image
Conclusion
This paper proposes an attention-guided enhancement solution for low-light image enhancement. We design a multi-branch network to handle enhance the brightness and handle the noise simultaneously. The key is to use the proposed ue-attention map and noise map to guide the enhancement in a region adaptive manner. We also propose a low-light image simulation pipeline and build a large-scale low-light enhancement benchmark dataset for model training and evaluation. Extensive experiments demonstrate that our solution outperforms state-of-the-art methods by a large margin. As for future direction, extending the proposed method to low-light video enhancement is of our interest.