The characterization and classification of white blood cells (WBC) are critical for the diagnosis of anemia, leukemia, and many other hematologic diseases. We developed WBC-Profiler, an unsupervised feature learning system for quantitative analysis of leukocytes. We demonstrate, through independent validation, that WBC-Profiler enables automatic extraction of complex and robust signatures from microscopic images without human-intervention and, thereafter, effective construction of interpretable leukocyte profiles, which decouples large scale complex leukocyte characterization from limitations in both human-based feature engineering/optimization and the end-to-end solutions provided by many modern deep neural networks. Further evaluation in a real-world clinical setting confirms that, compared with 23 clinicians from 8 hospitals (class-average-sensitivity, 0.798; class-average-specificity, 0.963; cell-average-timecost: 3.158  s), WBC-Profiler performs with significantly improved accuracy and speed (class-average-sensitivity, 0.890; class-average-specificity, 0.980; cell-average-timecost: 0.375  s). Our findings suggest that WBC-Profiler has the potential clinical implications.

Introduction
Hematology tests provide laboratory assessments of blood formation and blood disorders and play critical roles in the indication, diagnosis, and evaluation of many conditions, including infection, inflammation, and anemia. Among various hematology tests, the differential count of while blood cells (WBC) provides an important tool in diagnosing and monitoring infection and leukemic disorders, and the ratio of various kinds of leukocytes are commonly used as important markers. For example, the neutrophil to lymphocyte ratio (NLR) is used as a marker of subclinical inflammation, and recent studies suggest that increased NLR is an independent predictor of mortality in patients undergoing angiography or cardiac revascularization (Wang et al. 2014). Moreover, it is also associated with poor prognosis of various cancers (Templeton et al. 2014), such as esophageal cancer (Wang et al. 2014) or advanced pancreatic cancer (Xue et al. 2014).

Accurate characterization, detection, and classification of while blood cells into several categories, including Monocytes, Lymphocytes, Basophils, Eosinophils, Atypical lymphocytes, and Neutrophilic granulocytes, is critical for the ratio (proportion) assessment of leukocytes in blood cell slides. However, such a high-demand task in clinical laboratories heavily relies on manual annotation by pathologies based on a series of characteristics related to different cellular compartments as briefly summarized in Table 1, which is not only labor-intensive but also challenging given the shortage of experienced medical experts in many clinical laboratories. To overcome these obstacles, many efforts have been made towards the automatic blood cell classification. Among these, early development of commercial systems in the 1970s failed to revolutionize the field due to the high price and low accuracy of the products (Preston 1987). Recently, another commercial leukemia diagnosis system (Leuko), was developed to reveal an improved accuracy on cell classification based on naive Bayes classifiers. Meanwhile, research efforts on cell classification have also been evolving from fuzzy logic techniques (Sobrevilla et al. 1999) and support vector machines (SVMs) (Ushizima et al. 2005) to cellular neural networks (Wang and Wang 2006). However, these works were mostly developed with a limited amount of data and/or focused on images taken from specified instruments, which left their generalization capability insufficiently justified.

Table 1 Representative characteristics used by clinicians in clinical practice to differentiate various types of white blood cells
Full size table
Related Work
Motivated by recent neuroscience findings (Lee and Mumford 2003; Lee et al. 1998), unsupervised learning and deep learning techniques (Lecun et al. 1998; Huang and LeCun 2006; Hinton and Osindero 2006) have gained momentum during the past decade for object representation and recognition (e.g., face representation and recognition) (Simard et al. 2003; Osadchy et al. 2005; Kwolek 2005; Sukittanon et al. 2004). Furthermore, their applications in various biomedical tasks (McKenna et al. 1993; Elsalamony 2016; Manik et al. 2016; Zhang et al. 2016; Esteva et al. 2017) have demonstrated success with the potential to provide a new avenue for data-intensive clinical studies.

Among various biomedical tasks that have been revolutionized by the development of aforementioned machine learning techniques, the leukocyte classification has been reshaped with significantly improved accuracy due to the employment of deep neural networks (DNNs) (Shahin et al. 2017; Yu et al. 2017; Liu et al. 2019; Qin et al. 2018), where WBCsNet (Shahin et al. 2017) provided an end-to-end CNN architecture for the identification of different types of WBC; DeepVote (Yu et al. 2017) developed a deep assemble approach (i.e., combining classification results from various deep neural networks to vote for the final decision) for WBC classification; WBCaps (Liu et al. 2019) introduced a capsule architecture-based classification model for WBC type recognition; Cell3Net (Qin et al. 2018) constructed a deep residual neural network based leukocyte classifier for finer leukocyte classification; and Sahlol et al. (2020) presented a hybrid approach for efficient classification of WBC deploying VGGNet and enhanced Salp Swarm Algorithm (SESSA) for feature extraction and optimization, respectively. The main focus of these systems is to provide an end-to-end solution (i.e., from data to classification), which leaves the characterization of white blood cells inadequately addressed, and thus impeding the construction of leukocyte profile for other potentials, such as leukocyte profile interpretation, leukocytes profile differentiation among cell types as well as leukocytes profile association with, e.g., potential clinical endpoints.

Fig. 1
figure 1
Overall study design for the development and independent validation of WBC-Profiler in a multi-hospital clinical setting. It consists of 23 clinicians from 8 hospitals across China and facilitates independent evaluation of WBC-Profiler‚Äôs clinical impact through the comparison with individual clinicians and individual hospitals as well as all participating clinicians/hospitals

Full size image
Fig. 2
figure 2
The concept of training and inference with WBC-Profiler for leukocyte characterization and classification. a Main structure of WBC-Profiler, where the random patch extraction unit selects a set of vectorized image patches randomly from input cell images; the feed-backward reconstruction unit reconstructs the input signal (i.e., image patch) from a set of signatures learned from the input data; the feed-forward inference unit predicts the reconstruction coefficient (i.e., sparse code to be used as the feature representation for each individual image patch) for input data reconstruction; the characterization unit calculates the sparse codes for all image patches of an target cell image based on both the signatures and inference function derived from unsupervised learning and summarize them into a single profile as the representation of the target cell image; and finally, the classification unit labels each cell image with different cell types. b Examples of microscopic images of different types of white blood cells and the corresponding reconstruction results from the derived signatures. From top row to bottom row: Atypical lymphocytes, Basophils, Eosinophils, Lymphocytes, Monocytes and Neutrophilic granulocytes. c Signatures (1024 in total) automatically learned from our cell image dataset by WBC-Profiler, where the top 256 signatures (ranked by random-forest based on their contribution to leukocyte classification) were highlighted within red bounding box. d Mean profile with the top 256 signatures per cell type, where it is represented as the class-average contribution of each signature for the reconstruction of cell images in the same category (Color figure online)

Full size image
Fig. 3
figure 3
Main structure of WBC-Profiler and the corresponding training algorithm. a Main structure of WBC-Profiler, where ùêó is a set of vectorized image patches, randomly selected from input cell images; ùêôùëò is a set of sparse codes from the kth layer; and the final characterization of each cell image is the summarization of sparse codes, from the last layer. b Training and cross-validation diagram of WBC-Profiler. c Training algorithm of unsupervised signature learning module of WBC-Profiler

Full size image
To overcome the aforementioned challenges and to ensure the clinical impact of our work, we developed and validated WBC-Profiler, which unifies interpretability, scalability and performance within an extensive multi-hospital clinical setting for leukocytes characterization and classification. Furthermore, the development of WBC-Profiler is built upon our multi-center collaboration, as well as our multidisciplinary understanding of biomedical sciences and clinical practice, which is one of the keys for biomedical studies with machine learning.

Approach
We developed WBC-Profiler, an unsupervised feature learning system for leukocyte characterization and classification. It allows automatic acquisition of intrinsic signatures (i.e., patterns encoding both color and texture information) directly from raw data (microscopic images) that facilitate the efficient and effective characterization and classification of leukocytes, skipping conventional steps such as feature engineering (i.e., manually designing and optimizing features) while providing interpretable cell profiles that are typically inaccessible to many existing deep learning based systems (Shahin et al. 2017; Yu et al. 2017; Liu et al. 2019). We carried out a multi-hospital study, which involved 8 hospitals and 23 clinicians across China, to evaluate the clinical impact of WBC-Profiler via extensive comparison of its accuracy and speed with individual clinicians/hospitals as well as all participating clinicians/hospitals (Fig. 1).

The general principle of WBC-Profiler is illustrated in Fig. 2. It consists of unsupervised signature learning module, inference module, and visualization module to realize efficient and effective leukocyte characterization and classification, as well as convenient interpretation of derived results.

Table 2 Protocol and details about training and validation datasets
Full size table
The Unsupervised Signature Learning Module
Predictive Sparse Decomposition (PSD) (Kavukcuoglu et al. 2010a) was initially developed for efficient and effective learning of basis functions, and thereafter smooth approximation to the optimal representation on the task of visual object recognition, which has been widely adapted and extended for denoising (Qian and Shi 2014), semi-supervised learning (Lv et al. 2016) as well as tissue classification (Chang et al. 2015), etc. In addition, it provides a compact and robust learning framework compared to large-scale neural networks, which helps alleviate challenges with limited data scale, especially for many biomedical tasks including Leukocyte characterization. Therefore, we constructed the unsupervised feature learning module based on PSD to enable automatic acquisition of intrinsic signatures directly from limited raw data. Specifically, it is built upon the Stacked Predictive Sparse Decomposition (Stacked PSD) technique (Chang et al. 2015) for the construction of the hierarchical unsupervised learning framework, which has the demonstrated capability of capturing higher-level dependencies of input variables, thereby improving the effectiveness of the system in acquiring underlying regularities in the data (Chang et al. 2015). Unlike many unsupervised feature learning algorithms (Lee et al. 2007, 2008; Poultney et al. 2006; Yu et al. 2009), the feed-forward feature inference of Stacked PSD is very efficient, as it involves only element-wise nonlinearity and matrix multiplication. Therefore, it provides a highly efficient and effective solution for Leukocyte characterization. Specifically, given ùêó=[ùê±1,‚Ä¶,ùê±ùëÅ]‚àà‚Ñùùëö√óùëÅ as a set of vectorized image patches, the formulation and optimization of a single Stacked PSD layer are illustrated in Fig. 3 and described as follows:

minùêÉ,ùêô,ùêÜ,ùêñs.t. ‚Äñùêó‚àíùêÉùêô‚Äñ2ùêπ+ùúÜ‚Äñùêô‚Äñ1+‚Äñùêô‚àíùêÜùúé(ùêñùêó)‚Äñ2ùêπ‚Äñùêùùëñ‚Äñ22=1,‚àÄùëñ=1,‚Ä¶,‚Ñé
(1)
where ùêÉ=[ùêù1,‚Ä¶,ùêù‚Ñé]‚àà‚Ñùùëö√ó‚Ñé is a set of the dictionary elements; ùêô=[ùê≥1,‚Ä¶,ùê≥ùëÅ]‚àà‚Ñù‚Ñé√óùëÅ is the sparse feature matrix; ùêÜùúé(ùêñùêó) is the auto-encoder; ùêÜ=diag(ùëî1,‚Ä¶,ùëî‚Ñé)‚àà‚Ñù‚Ñé√ó‚Ñé is a scaling matrix with diag being an operator aligning vector, [ùëî1,‚Ä¶,ùëî‚Ñé], along the diagonal; ùúé(‚ãÖ) is the element-wise sigmoid function; and ùúÜ is a regularization constant. Joint minimization of Eq. (1) with respect to the quadruple ‚ü®ùêÉ,ùêô,ùêÜ,ùêñ‚ü©, enforces the inference of the nonlinear regressor ùêÜùúé(ùêñùêó) to be similar to the optimal sparse codes, ùêô, which can reconstruct ùêó over ùêÉ (Kavukcuoglu et al. 2008).

As shown below, optimization of Eq. (1) is iterative, where the algorithm terminates when either the objective function is below a preset threshold or the maximum number of iterations has been reached.

1.
Randomly initialize ùêÉ, ùêñ, and ùêÜ.

2.
Fixing ùêÉ, ùêñ, and ùêÜ, minimize Eq. (1) with respect to ùêô, where ùêô can be either solved as a ‚Ñì1-minimization problem (Lee et al. 2007) or equivalently solved by greedy algorithms, e.g., Orthogonal Matching Pursuit (OMP) (Tropp and Gilbert 2007).

3.
Fixing ùêÉ, ùêñ and ùêô, solve for ùêÜ, which is a simple least-square problem with analytic solution.

4.
Fixing ùêô and ùêÜ, update ùêÉ and ùêñ, using the stochastic gradient descent algorithm.

5.
Repeat [2]‚Äì[4] until stopping condition is satisfied.

The Inference Module
The inference module of WBC-Profiler consists of characterization and classification units, where the former extracts patch-level features with a sliding window from the leukocytes images and constructs the image-level profiles through specific pooling operation and the latter utilizes the derived profiles for leukocyte classification. Specifically, with the derived signatures from the unsupervised learning module, WBC-Profiler extracts patch-level features for each image patch through a feed-forward fashion, where an image patch refers to a sub-image with fixed size from the original microscopic image, and the patch-level feature of a single image patch refers to the sparse code (coefficients) for the reconstruction of this specific image patch with derived signatures. The final profile (image-level representation) for the cell image is constructed with specific pooling operation (detailed in Sect. 4.2) over all patch-level features from the cell image.

The Visualization Module
The visualization module of WBC-Profiler provides an intuitive and convenient means for data visualization and interpretation, including signature visualization (as illustrated in Fig. 2c), profile visualization (as illustrated in Figs. 2d and 4), heatmap (as illustrated in Fig. 6a, c), and feature embedding (as illustrated in Fig. 6b, d).

Multi-hospital Clinical Study
Leukocyte Image Datasets
Two leukocyte image datasets were independently collected and labeled at the Affiliated Drum Tower Hospital of Nanjing University Medical School in Nanjing and 301 Hospital in Beijing respectively, where the former serves for training and cross-validation purposes, and the latter was utilized for independent validation with both pre-built computational models from training dataset as well as participating clinicians. Data collection protocol and details about the datasets are summarized in Table 2. It is worth mentioning that the imbalanced sample distribution of the training dataset was maintained to respect the sample distribution during clinical practice at the Drum Tower Hospital.

Fig. 4
figure 4
a Mean profile with the all 1024 signatures per cell type, where it is represented as the class-average contribution of each signature for the reconstruction of cell images in the same category. b Segments of the mean profile with 16 signatures at different locations of the entire profile

Full size image
Experimental Evaluation
We provided extensive evaluation of WBC-Profiler on the aforementioned leukocyte image datasets with respect to leukocyte characterization and classification as well as interpretation of derived results. The parameter settings in our evaluation were optimized quantitatively or empirically, as shown in Fig. 5.

Fig. 5
figure 5
a Combined error of image patch reconstruction and sparse regression along training iterations. b Normalized error of image patch reconstruction along training iterations. c Leukocyte classification error along training iterations with different pooling strategies. d Leukocyte classification error with mean-pooling and varying number of signatures (256, 512, 1024, 2048). e Leukocytes classification error with different number of network layers, where the first layer, second layer and third layer consist of 1024, 2048, 4096 filters, respectively. f Leukocyte classification error with different filter sizes. g Leukocyte reconstruction results along selected training iterations

Full size image
Specifically, in our study, one unsupervised learning layer with 1024 signatures/kernels at a fixed size of 20-by-20 pixels was adopted, where the number of layers, dictionary size, and kernel size were determined through quantitative evaluation (see Fig. 5d‚Äìf); the training process for unsupervised signature learning was set to be 100 iterations with the training errors illustrated in Fig. 5a, b. It suggests that the unsupervised signature learning converges around 20 iterations, which was further confirmed by the classification performance along training iterations as shown in Fig. 5c. A detailed examination of image reconstruction, as illustrated in Fig. 5g shows that the signatures learned with 20 iterations are capable of producing perceptually reasonable reconstructions of the data, which provides an intuitive explanation and guidance on the selection of training iterations. The step size for patch-level feature extraction was fixed to be 5 pixels, and mean-pooling strategy among different popular pooling strategies was selected based on the cross-validation performance via support vector machine (SVM) classifier, as illustrated in Fig. 5c.

Fig. 6
figure 6
WBC-Profiler provides effective leukocyte characterization. a Heatmap of training dataset based on signatures selected in correspondence to some of the peaks in the mean profile (annotated by dotted vertical lines in Fig. 2d), where zero-mean normalization is applied for better visualization. It is clear that the relative abundance of signatures: S216, S68, S18, S3 and S96, are significantly higher in Eosinophil and Neutrophilic Granulocyte categories, which we suggest is due to the larger portion of cytoplasm-like region in these two categories than in other categories. b Feature embedding based on the top 256 signatures demonstrates the effectiveness of WBC-Profiler in unsupervised signature learning for leukocyte characterization, where t-Distributed Stochastic Neighbor Embedding (tSNE, an unsupervised method for feature embedding/dimension reduction) reveals highly separable clusters. c Heatmap of validation dataset confirms the robustness of signatures learned from training dataset. d Feature embedding on validation dataset confirms the effectiveness of leukocyte characterization. Note The pre-trained signatures and feature extraction models, from training dataset, were directly applied to validation dataset. Abbreviation: ALY atypical lymphocyte, BAS basophil, EOS eosinophil, LYM lymphocyte, MON monocyte, NEU neutrophilic granulocyte

Full size image
Evaluation of WBC-Profiler on Leukocyte Characterization
To evaluate the capability of WBC-Profiler on leukocyte characterization, we visualized the signatures acquired by WBC-Profiler from our leukocyte training dataset in Fig. 2c. It contains 1024 signatures, and captures information from both color and texture domains, which cannot be easily achieved manually. With the derived signatures, WBC-Profiler extracts patch-level features for each image patch through a feed-forward fashion, where an image patch refers to a sub-image with fixed size (i.e., 20 pixel by 20 pixel in our study) from the original microscopic image, and the patch-level feature of a single image patch refers to the sparse code (coefficients) for the reconstruction of this specific image patch with derived signatures. The final profile for the cell image is constructed with mean-pooling operation over all patch-level features from the cell image, which constructs the image-level representation as the average sparse code (i.e., average reconstruction coefficients) over all the image patches from the cell image. Heatmap of selected signatures on training dataset (Fig. 6a) clearly indicates their ‚Äúdifferential abundance‚Äù across cell types and provides an intuitive way to evaluate/intepret the contribution of individual signature for leukocyte image construction/composition. Furthermore, feature embedding of high-dimensional profiles on training dataset into 2-Dimensional (2D) space leads to cell-type-specific clusters (as illustrated in Fig. 6b), which demonstrates the effectiveness of WBC-Profiler in leukocyte characterization and differentiation.

The application of pre-derived signatures on our independent validation dataset reveals highly repeatable signature abundance (Fig. 6c) across cell types as well as cell-type-specific clusters, which strongly demonstrate the robustness of WBC-Profiler in terms of signature learning and leukocyte characterization.

Evaluation of WBC-Profiler on Leukocyte Classification
To evaluate the capability of WBC-Profiler on leukocyte classification, we have compared it with two of the state-of-the-art techniques in the field of leukocytes classification, i.e., DeepVote (Yu et al. 2017) and WBCaps (Liu et al. 2019), and with one of the most successful deep learning techniques in the field of object recognition, i.e., ResNet-152 (He et al. 2016). It is worth to mention that DeepVote is an assembly of five different deep neural network models, including ResNet50 (He et al. 2016), Inception V3 (Szegedy et al. 2015), VGG 16 (Simonyan and Zisserman 2014), VGG 19 (Simonyan and Zisserman 2014), and Xception (Chollet 2017), and the final decision of on an input cell image is the consensus of independent decisions from the aforementioned models. According to the authors of DeepVote (Yu et al. 2017), this design improves the immunity to data noise and therefore leads to more favorable and stable results compared to traditional machine learning techniques for leukocyte classification. More specifically, the training of DeepVote and ResNet-152 was based on pre-trained models from ImageNet (Deng et al. 2009), where only the last layer of each neural network was fine-tuned independently with the leukocyte image dataset; and the training of WBCaps was directly based on our leukocyte training dataset.

Both cross-validation and independent validation were included in our extensive evaluation: (i) half-half cross-validation was employed with 10 iterations, where, at each iteration, we randomly selected 50% of the data per cell type for training and used the rest for testing; and (ii) during independent validation, all the models in comparison were trained on the entire training set and then applied to the validation dataset. The performance in terms of F1-Score, sensitivity (recall), specificity, and precision were reported in Fig. 7, where let ùêìùêè be correctly identified sample; ùêÖùêè be incorrectly identified samples; ùêìùêç be correctly rejected samples; ùêÖùêç be incorrectly rejected samples, the above performance metrics are defined as follows,

sensitivity=specificity=precision=F1-Score=ùêìùêèùêìùêè+ùêÖùêçùêìùêçùêìùêç+ùêÖùêèùêìùêèùêìùêè+ùêÖùêè2ùêìùêè2ùêìùêè+ùêÖùêè+ùêÖùêç
(2)
Our cross-validation on training dataset (Fig. 7a‚Äìc) indicates that WBC-Profiler outperforms DeepVote, WBCaps and ResNet-152 in terms of the overall leukocyte classification performance and classification stability, as measured by average F1-Score and standard error of F1-Score across cell types. More specifically, WBC-Profiler not only exceeds these techniques on cell type(s) with dominant amount of samples (e.g., Neutrophilic granulocyte), but also provides much more consistent performance on rare cases (e.g., Eosinophil). Although datasets with balanced samples per category are highly desirable and beneficial for modern machine learning tasks, the imbalanced nature of samples requires urgent attention and investigation in many scientific domains, especially for clinical studies. Therefore, the unification of performance and stability becomes critical for machine learning systems in, e.g., clinical tasks, where fortunately WBC-Profiler provides a well-balanced solution towards it.

Fig. 7
figure 7
WBC-Profiler enables accurate leukocyte classification. a, d Confusion matrix from DeepVote, ResNet-152, WBCaps and WBC-Profiler for leukocyte classification with absolute cell image numbers during cross-validation and independent validation, respectively. b Accuracy during cross-validation plotted with 75% confidence interval, where different numbers of stars indicate different levels of statistical significance and zero star indicates statistically non-significant (i.e., p-value ‚â• 0.05). c, e Detailed classification performance metrics during cross-validation and independent validation, respectively, where ùêÉ, ùêë, ùêÇ, and ùêñ refer to DeepVote, ResNet-152, WBCaps, and WBC-Profiler, respectively; CELL TYPE AVERAGE refers to the average performance across cell types; and CELL TYPE STDERR refers to the standard error of performance across cell types. Abbreviation: ATLYM atypical lymphocyte, BAS basophil, EOS eosinophil, LYM lymphocyte, MONO monocyte, NEUG neutrophilic granulocyte

Full size image
Moreover, our double-blind validation further confirms the superior performance of WBC-Profiler over other techniques in comparison (Fig. 7c, d). Although each individual approach experiences certain amount of performance decay from cross-validation to double-blind validation (Fig. 8c), WBC-Profiler remains to be the most robust approach in terms of classification stability during translation (from one hospital to the other). We suggest the stable classification performance of WBC-Profiler comes from the robustness and consistency during unsupervised feature learning and leukocytes characterization thereafter, which has been demonstrated with highly repeatable signature abundance (Fig. 6a, c) and cell type clusters (Fig. 6b, d) across hospitals. Furthermore, compared with DeepVote and ResNet-152, WBC-Profiler also performs with significantly improved scalability (Fig. 8a, b).

Fig. 8
figure 8
WBC-Profiler provides a scalable and robust leukocyte classification solution. a Comparison of network/model scales of DeepVote, ResNet-152, WBCaps, and WBC-Profiler, respectively. b Comparison of model efficiency (computational time per cell during prediction) of DeepVote, ResNet-152, WBCaps, and WBC-Profiler, respectively. In our study, WBC-Profiler was evaluated on a CPU desktop with Intel(R) Xeon(R) CPU E5-1650 and multi-thread settings, while DeepVote, WBCaps, and ResNet-152 were evaluated on a GPU server with an NVIDIA GeForce RTX 2080 Ti. c Comparison of cross-validation (10-fold, on training dataset) and independent validation (on validation dataset) accuracy of DeepVote, ResNet-152, WBCaps, and WBC-Profiler, respectively

Full size image
Given the small amount of data (compared to e.g., ImageNet) in our study as well as the large network scale of ResNet-152, it is not very surprising to notice that ResNet-152 performs statistically closely (i.e., p-value>0.05) to WBC-Profiler during cross-validation (Fig. 7c), while suffers much more than WBC-Profiler during translation (i.e., more performance decay from training hospital to validation hospital), due to the potential problem of over-fitting, which is further confirmed by the evidence from DeepVote and WBCaps (Fig. 8c). It is also interesting to notice that DeepVote, with the most network parameters, experienced less translational performance decay compared with ResNet-152, which suggests the value of assemble approach, especially in terms of translational stability. Furthermore, we believe that the potential of large scale neural networks (e.g., ResNet-152) in our study have been largely impaired by the insufficient data scale, which unfortunately exists in many clinical studies and makes unsupervised feature learning a better alternative in many similar cases (Ahn et al. 2019).

Table 3 Participating hospitals in our clinical validation, where NPC stands for number of participating clinicians and AS stands for average seniority measured by the average years of clinical experience
Full size table
Fig. 9
figure 9
WBC-Profiler provides highly competitive performance in a multi-hospital clinical environment. a Class-average receiver operating characteristic (ROC) of WBC-Profiler, and the individual/average performance of clinicians. b, c Class-average sensitivity and specificity, respectively. d Cell-average efficiency. Note, Hi refers to the ith hospital; Meta refers to the combination of all hospitals; AUC refers to area under curve; b‚Äìd are plotted with 75% confidence interval

Full size image
Fig. 10
figure 10
Class-specific (per row) sensitivity and specificity of WBC-Profiler as well as all participating hospitals plotted in 75% confidence interval. Note: Hi refers to the ith hospital; Meta refers to the combination of all participating clinicians/hospitals.

Full size image
Collectively, with all extensive evaluations in terms of both leukocyte characterization and classification above, we suggest that the major advantages of WBC-Profiler reside in two folds:

1.
WBC-Profiler enables systematic study of leukocytes, which not only produces more favorable leukocyte classification performance, but also constructs interpretable leukocyte profiles with many other potentials, including, but not limited, to imaging biomarker discovery and clinical justification; and,

2.
WBC-Profiler provides a computationally efficient, effective, and robust solution for translational studies. As shown in Fig. 8a, the number of parameters in WBC-Profiler is significantly less than the number of parameters in both DeepVote and ResNet-152, which helps improve the scalability in both training and prediction. Furthermore, due to the compact network structure as well as the nature of unsupervised learning, WBC-Profiler suffers less from over-fitting, and therefore produces more stable performance not only across imbalanced cell types (Fig. 6), but also across datasets (Fig. 8c), independently collected from different hospitals.

All the observations above further confirm the effectiveness of WBC-Profiler for leukocyte characterization and demonstrates the capability of WBC-Profiler for accurate leukocyte classification.

Besides the demonstrated merits of WBC-Profiler, we also realize that many existing unsupervised learning techniques (Bengio et al. 2013; Ahn et al. 2019) can be potentially deployed in place of Stacked PSD for leukocyte characterization. Given our extensive justification of WBC-Profiler in comparison with the state-of-the-arts in the field, we believe that further evaluation of alternative unsupervised learning techniques instead of Stacked PSD will not affect the clinical potentials of WBC-Profiler and therefore will be included in our future study for system optimization purpose. Furthermore, experimental re-visits on the performance optimization and over-fitting alleviation of large scale deep neural networks (e.g., ResNet-152) will also be included in our future study together with our tremendous undergoing efforts on data collection.

Multi-hospital Clinical Validation
To further confirm the potential of WBC-Profiler for clinical implications, we carried out an extensive multi-hospital clinical validation, where 23 clinicians from 8 collaborating hospitals (2‚Äì3 clinicians/hospital) were recruited for independent leukocyte labeling of our validation dataset. The selection of collaborating hospitals and participating clinicians follows the rules as follows: (i) the collaborating hospitals were selected from some representative regions (i.e., east, central, and northwest) in China; (ii) the collaborating hospitals represent the top-grade hospitals in their corresponding regions; (iii) the participating clinicians are actively involved in clinical practice and are representative of their corresponding hospitals. Detailed information about our collaborating hospitals is summarized in Table 3.

During clinical validation, the labeling and recording tasks were decoupled to ensure the accurate calculation of time-cost during clinical evaluation, where participating clinicians continuously and independently labeled the validation dataset in a double-blind fashion, while assisting technicians simultaneously recorded the labeling results. After evaluation, the performance as well as the efficiency were summarized and reported in Figs. 9 and 10. Our multi-hospital clinical validation strongly suggests that WBC-Profiler produces highly competitive performance (Fig. 9a‚Äìc and 10) with improved stability (Fig. 9b, c) and efficiency (Fig. 9d) compared with 23 independent clinicians from 8 hospitals. It is believed that WBC-Profiler has the potential to overcome the challenge due to the large variation of both clinical expertise as well as the corresponding diagnostic accuracy across hospitals, and thus has potential clinical implications.

Study Revisit
Revisit on Convolutional Feature Learning
Compared with patch-based learning strategy, convolutional feature learning produces translational-invariant filters and therefore effectively reduces feature redundancy potentially introduced by patch-based learning. Here, we employed convolutional sparse coding (CSC) (Kavukcuoglu et al. 2010b) in place of Stacked PSD in the unsupervised learning module, and evaluated its performance with fixed filter size 21√ó21 and various number of filters (256, 512, 1024). It shows(Fig. 11), through cross-validation (DrumTower dataset) and independent validation (301 dataset) , that CSC produces very stable while less favorable performance compared to Stacked PSD across different configurations. We suggest that,

1.
The stability of CSC across different number of filters is due to its translational-invariant property. Unlike Stacked PSD, which requires relatively larger amount of filters (in our case 1024 or beyond, Fig. 5d), CSC produces stable performance with much more compact representation using significantly less filters (256 filters in our case);

2.
The less favorable perform of CSC compared to Stacked PSD in the unsupervised learning module may be due to the differences of filters learned by these two strategies, where Stacked PSD filters (Fig. 2c) encode a combination of cell color/texture information; while CSC filters (Fig. 11a) have a clear emphasis on e.g., cell edges and small particles. Although all these information, to certain extent, agrees with clinical practice (Table 1), their impact on both algorithmic representation and classification may vary, and consequently leads to the difference in performance.

Fig. 11
figure 11
Performance revisit with convolutional feature learning, where CSC-k refers to convolutional sparse coding with ùëò‚àà(256,512,1024) filters, protocol for both cross-validation (DrumTower dataset) and independent validation (301 dataset) is consistent with Sect. 4.2, different numbers of stars indicate different levels of statistical significance and zero star indicates statistically non-significant (i.e., p-value ‚â• 0.05), and performances are plotted with 75% confidence interval

Full size image
Fig. 12
figure 12
Details and representative examples of new training and validation datasets, where the training dataset is the combination of datasets from DrumTower hospital and 301 hospital, and the validation dataset is from LISC

Full size image
Revisit on Translational Impact
To further evaluate the translational impact of WBC-Profiler as well as the techniques in comparison, we adopted LISC dataset (Rezatofighi and Soltanian-Zadeh 2011) due to its availability as well as the suitability of study design compared with ours. Specifically, LISC was initially created for the task of nucleus and cytoplasm segmentation, as well as recognition of different white blood cells in hematological images. It contains five types of WBCs (i.e., Basophils, Eosinophils, Lymphocytes, Monocytes and Neutrophilic granulocytes ) with a total number of 257 manually annotated cells acquired by a light microscope (Microscope-Axioskope 40) from the stained peripheral blood using an achromatic lens at 100X. Representative examples are illustrated in Fig. 12, which presents significant amount of variations between our datasets and LISC, as well as much smaller data scale of LISC compared to ours. To better explore the capability of deep networks (i.e., DeepVote and ResNet-152) as well as to accommodate the variations across training and validation datasets, we formed the new training dataset (Tk) by (1) combining the datasets from DrumTower Hospital and 301 Hospital; and (2) randomly (with 10 bootstrapping iterations) selecting ùëò‚àà(5,10,15,20) cell images per category from LISC; and thereafter tested on the remaining of LISC. Specifically, (1) the auto-encoder of WBC-Profiler pre-trained on the dataset from DrumTower hospital (Section 4.2) remains fixed, and only the classifier were re-trained towards Tk; (2) the training of DeepVote and ResNet-152 was based on pre-trained models from ImageNet (Deng et al. 2009), where only the last layer of each neural network was fine-tuned independently with Tk; and (3) the training of WBCaps was directly based on Tk. Interestingly, our experimental results (Fig. 13) reveal that,

1.
WBC-Profiler consistently outperforms DeepVote, WBCaps and ResNet-152 with various training configurations (i.e., Tk);

2.
ResNet-152 and DeepVote outperform WBCaps when more than 10 and 15 random samples per category from LISC were utilized during training, respectively.

These observations clear demonstrate the robustness and consistency of WBC-Profiler, as well as the potential of large scale neural networks with increased training scale (i.e., combined data from DrumTower and 301 hospitals) as well as increased training samples from the target dataset, especially when large data variations are presented across datasets and hospitals.

Fig. 13
figure 13
WBC-Profiler provides consistent performance on public dataset, where Tk refers to training configuration with all data from both DrumTower and 301 hospitals as well as randomly selected k cell images from LISC dataset, different numbers of stars indicate different levels of statistical significance and zero star indicates statistically non-significant (i.e., p-value ‚â• 0.05), and performances are plotted with 75% confidence interval. It is clear that WBC-Profiler consistently outperforms the techniques in comparison across all configurations; meanwhile, ResNet-152 and DeepVote outperform WBCaps when more than 10 and 15 random samples per category from LISC were utilized during training, respectively

Full size image
Conclusions and Future Work
In summary, we developed and validated WBC-Profiler, an unsupervised feature learning system for efficient, effective, and interpretable leukocyte characterization and classification. Furthermore, to the best of our knowledge, WBC-Profiler is the first advanced machine learning system that provides both leukocyte characterization and classification with demonstrated advantages over both existing techniques as well as clinicians through extensive justification in a multi-hospital clinical environment.Footnote1 The designed architecture ensures WBC-Profiler‚Äôs performance in precision, accuracy, and speed. Furthermore, WBC-Profiler decouples large scale complex leukocyte characterization from limitations in both human-based feature engineering/optimization and the end-to-end solutions and therefore further allows the extraction of highly multiplexed intrinsic and robust/interpretable signatures from large scale leukocyte datasets. Independent evaluation and comparison in a multi-hospital clinical setting further confirms the potential clinical impact of WBC-Profiler.

Our future work includes (i) System-level optimization of WBC-Profiler by extensive evaluation of other unsupervised feature learning techniques in place of Stacked PSD for leukocyte characterization; (ii) Experimental re-visits on the performance optimization and over-fitting alleviation of large scale deep neural networks (e.g., ResNet-152) together with our tremendous undergoing efforts on data collection; (iii) Further evaluation of novel techniques (Lin et al. 2017; Ouyang et al. 2016) specifically designed to for imbalanced sample distributions; and (iv) Continuous improvement of WBC-Profiler as an open source project in terms of reliability, sustainability, and reusability to benefit the community at large.